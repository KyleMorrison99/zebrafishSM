---
Title: "Mapping the Behavioural Impacts of Pesticide Exposures on Zebrafish: A Systematic Evidence Map and Bibliometric Analysis "
authors: "Kyle Morrison, Manuela Santana, Yefeng Yang, Malgorazata Lagisz and, Shinichi Nakagawa"
subtitle: Supplemental file s2
output: 
  rmdformats::robobook:
    code_folding: show
    code_download: true
    toc_depth: 4
editor_options: 
  chunk_output_type: console
---

In this Rmarkdown we provide the following workflow:

- Objective 1.	To investigate the types of pesticides and pesticide classes, both in terms of chemical structure and target organism, that have been used in studies examining the effects of pesticide exposure on non-larval zebrafish behaviour.

- Objective 2. 	To investigate the study designs employed to assess the effects of pesticide exposure on the behaviour of non-larval zebrafish.  

- Objective 3.  To identify the specific behaviours that have been investigated in pesticide exposure studies that use non-larval zebrafish as a model.

- Objective 4.	To assess the research outputs of different countries and investigate the level of collaboration between authors amongst different countries. 

# **Load packages and data**

## Load packages

```{r}
rm(list = ls())
knitr::opts_chunk$set(echo = TRUE)
pacman::p_load(tidyverse,
               here,
               stringr,
               knitr,
               formatR,
               forcats,
               ggplot2,
               hrbrthemes, # for ggplot2
               patchwork, # for ggplot2
               bibliometrix,
               igraph, 
               tidyr,
               circlize,
               cowplot, 
               mapproj)
```


## Load data
All extracted data is stored in five separate **.csv** files representing different aspects of the data (extracted via structured predefined Google Forms - one per table). 

Bibliographic data records are exported from Scopus (including cited references field) in .bib format and locally saved as **scopus.bib**.    

```{r}
# Load data set containing background information on each study
bib <- read_csv(here("data", "zf_sm_bibliometrics.csv"), skip = 0) # 83 rows 9 columns 

# Load data set containing information on the design of each study 
sd <- read_csv(here("data","zf_sm_study_details.csv"), skip = 0) #  83 rows 10 columns 

# Load data set containing details of each pesticide used in each exposure studies
pd <- read_csv(here("data", "zf_sm_pesticide_details.csv"), skip = 0) # 83 rows 9 columns 

# Load data set containing details of dosage and duration of pesticide exposure 
pdo <-read_csv(here("data","zf_sm_pesticide_dosage.csv"), skip = 0) # 108 rows 12 columns 

# Load data set containing details of behaviorus measured in response to pesticide exposure 
bd <- read_csv(here("data", "zf_sm_behaviour_details.csv"), skip = 0) # 83 rows 13 columns 

# Load bibliometric information extracted from scopus 
bib_sco <- convert2df(here("data","scopus.bib"), dbsource = "scopus", format = "bibtex") # 79 rows 38 columns 
```

# Objective 0: General literature characteristics
## fig 2- study time time trends
```{r}

# Count the number of articles by year
fig2 <- bib %>%
  count(publication_year) %>%
  
  # Create a bar chart with publication year on x-axis and count on y-axis
  ggplot(aes(x = publication_year, y = n)) +
  
  # Customize the appearance of the bars
  geom_bar(stat = "identity", fill = "#5F85AE", color = "white", alpha = 0.8, position = position_dodge(0.9)) +
  
  # Add labels to the bars
  geom_text(aes(label = n), position = position_stack(vjust = 0.5), fontface = "bold", color = "white", size = 5, hjust = 0.5) +
  
  # Customize the appearance of the plot
  theme_minimal() +
  labs(x = "Year", y = "Article Count") +
  theme(legend.position = "none",
        axis.title.x = element_text(size = 15, face = "bold"),
        axis.title.y = element_text(size = 15, face = "bold"),
        axis.text.x = element_text(angle = 45, hjust = 1, size = 15),
        axis.text.y = element_text(size = 15),
        panel.grid.major.y = element_line(color = "gray"),
        panel.grid.minor.y = element_blank(),
        plot.title = element_text(size = 16, face = "bold"))
 

fig2
# ggsave(here("figures", "fig2_time_trends.pdf"), width = 16, height = 10, units = "cm", scale = 2, dpi = 300)
```


#  Objective 1.	To investigate the types of pesticides and pesticide classes, both in terms of chemical and target, that have been used in experiments examining the effects of pesticide exposure on zebrafish behaviour.

## fig3a - plot for total of individual pesticides used in pesticide exposure studies
```{r}
# Separate rows with multiple pesticides, count their occurrence, and combined all pesticide that occured once as "other"
total_pesticide_count <- pd %>%
  separate_rows(pesticide_investigated, sep = ", ") %>%
  count(pesticide_investigated) %>%
  mutate(pesticide_investigated = ifelse(n == 1, "other", as.character(pesticide_investigated))) %>%
  # "other" includes tribotyltin, terbutylazine, sodium fluride, pyrimethonil, pyraclostrobin, propiconazole, prochloraz, parathion, paclobutazol, monocotophos, methylbenzoate, methylbenzoate, methomyl, mecroprop, linuron, endosulfan, diuron, difenoconazole, dicamba,   cyprodinil, chlorothalonil, carbofuran, carbaryl, broflanilide and boscalid. 
  group_by(pesticide_investigated) %>%
  summarise(n = sum(n))

  # Calculate pesticide count as a percentage 
  pesticide_pct <- total_pesticide_count %>%
  mutate(proportion = n/sum(total_pesticide_count$n),
         percentage = proportion*100)
  
# Create a bar chart with the count of pesticides on the x-axis and pesticides on the y-axis
fig3a <-  ggplot(pesticide_pct, aes(x = reorder(pesticide_investigated, n), y = percentage)) +
  
  # Customize the appearance of the bars
  geom_bar(stat = "identity", fill = "#5F85AE", color = "white", alpha = 0.8, position = position_dodge(0.9)) +
  
  # Add labels to the bars for absolute count 
  geom_text(aes(label = n), position = position_stack(vjust = 0.5), color = "white", fontface = "bold", size = 5) +
  

  # Add labels to the bars for percentage 
 geom_text(data = pesticide_pct, aes(label = paste0(round(percentage,1), "%")), 
            position = position_dodge(width = 0.9), hjust = -0.2, size = 5, color = "black", fontface = "bold") +
  
  # Customize the appearance of the plot
  labs(x = "Pesticide", y = "Percentage") +
  theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
        axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title.x = element_text(size = 15),
        axis.title.y = element_text(size = 15),
        axis.text.x = element_text(size = 15),
        axis.text.y = element_text(size = 15),
        axis.title = element_text(size = 15),
        plot.title = element_blank()) +
        coord_flip() +
        ylim(0,30)


 fig3a
# ggsave(here("figures", "fig3a_pesticide_count.pdf"), width = 16, height = 10, units = "cm", scale = 2, dpi = 300)
```

## fig3b - total for each pesticide target class used in pesticide exposure studies
```{r}
# Separate rows with multiple pesticides and count their occurrence
total_target_class_count <- pd %>%
  separate_rows(pesticide_target_class, sep = ",\\s*") %>%  
  count(pesticide_target_class) 

# Calculate target class count as a percentage 
  target_class_pct <- total_target_class_count %>%
  mutate(proportion = n/sum(total_target_class_count$n),
         percentage = proportion*100)
  
# Create a bar chart with the count of target classes  on the x-axis and pesticides target class  on the y-axis
fig3b <- ggplot(target_class_pct, aes(reorder(pesticide_target_class, n), y = percentage)) +
  
  # Customize the appearance of the bars
  geom_bar(stat = "identity", fill = "#5F85AE", color = "white", alpha = 0.8, position = position_dodge(0.9)) + 
  
  # Add labels to the bars for absolute count
  geom_text(aes(label = n), position = position_stack(vjust = 0.5), color = "white", fontface = "bold", size = 7) +
  
  # Add labels to the bars for percentage 
 geom_text(data = target_class_pct, aes(label = paste0(round(percentage, 1), "%")), 
            position = position_dodge(width = 0.9), hjust = -0.2, size = 7, color = "black", fontface = "bold") +
    
  # Customize the appearance of the plot
  labs(x = "Pesticide Target Class", y = "Percentage") +
  theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
    axis.line.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.text.x = element_text(size = 20),
    axis.text.y = element_text(size = 20),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    plot.title = element_blank()) +
    coord_flip() +
    ylim(0, 80)


 fig3b
# ggsave(here("figures", "fig3b_pesticide_target_count.pdf"), width = 16, height = 10, units = "cm", scale = 2, dpi = 300)
```

## fig3c - total for chemical class 
```{r} 
# Separate rows with multiple pesticides and count their occurrence, then filter for cases with more than one occurrence
total_chemical_class_count <- pd %>%
  separate_rows(pesticide_chemical_class, sep = ",\\s*") %>%  
  count(pesticide_chemical_class) %>%
    mutate(pesticide_chemical_class = ifelse(n == 1, "other", as.character(pesticide_chemical_class))) %>%
  # "other" includes tribotyltin, terbutylazine, sodium fluride, pyrimethonil, pyraclostrobin, propiconazole, prochloraz, parathion,       paclobutazol, monocotophos, methylbenzoate, methylbenzoate, methomyl, mecroprop, linuron, endosulfan, diuron, difenoconazole, dicamba,   cyprodinil, chlorothalonil, carbofuran, carbaryl, broflanilide and boscalid. 
  group_by(pesticide_chemical_class) %>%
  summarise(n = sum(n))

# Calculate target class count as a percentage 
  chemical_class_pct <- total_chemical_class_count %>%
  mutate(proportion = n/sum(total_chemical_class_count$n),
         percentage = proportion*100)
  
  # Create a bar chart with the count of chemical classes on the x-axis and pesticides chemical class on the y-axis
 fig3c <-  ggplot(chemical_class_pct, aes(x = reorder(pesticide_chemical_class,n), y = percentage)) +
  
  # Customize the appearance of the bars
  geom_bar(stat = "identity", fill = "#5F85AE", color = "white", alpha = 0.8, position = position_dodge(0.9)) +
  
  # Add labels to the bars
  geom_text(aes(label = n), position = position_stack(vjust = 0.5), color = "white", fontface = "bold", size = 5) +
  
   
  # Add labels to the bars for percentage 
 geom_text(data = chemical_class_pct, aes(label = paste0(round(percentage,1), "%")), 
            position = position_dodge(width = 0.9), hjust = -0.2, size = 5, color = "black", fontface = "bold") +
   
  # Customize the appearance of the plot
  labs(x = "Pesticide Chemical Class", y = "Percentage") +
  theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
    axis.line.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.text.x = element_text(size = 20),
    axis.text.y = element_text(size = 15),
    axis.title.x = element_text(size = 20),
    axis.title.y = element_text(size = 20),
    plot.title = element_blank()) +
    coord_flip() +
    ylim(0, 40)
    

 fig3c
# ggsave(here("figures", "fig3c_pesticide_chemical_count.pdf"), width = 16, height = 10, units = "cm", scale = 2, dpi = 300)
```

## fig3 combined 
```{r, fig.height=10, figwidth = 20}
# Combine three plots into a single plot using a grid layout
fig3 <- ((fig3a) | (fig3b / fig3c) + plot_annotation(tag_levels = "A"))

fig3
#ggsave(here("figures", "fig3_pesticide_count_combined.pdf"), width = 16, height = 10, units = "cm", scale = 2, dpi = 300)
```

Objective 2. To investigate pesticide exposure study designs such as concentration and duration of exposure, life stages of zebrafish used in each study and the sample sizes used.

## fig4a - total route of exposure
```{r}
# Count the total occurrence of each route in the data set
total_route_count <- pdo %>% 
                     count(route)

# Count the proportion and percentage of each route in the data set
route_pct <- pdo %>%
  count(route) %>%
  mutate(proportion = n/sum(total_route_count$n),
         percentage = proportion*100)

# Create a bar chart with the percentage of pesticides by route of exposure on the x-axis and the routes of exposure on the y-axis
fig4a <- ggplot(route_pct, aes(x = reorder(route, percentage), y = percentage)) +
  
  # Customize the appearance of the bars
  geom_bar(stat = "identity", fill = "#5F85AE", color = "white", alpha = 0.8, position = position_dodge(0.9)) +
  
  # Add absolute count to bars
  geom_text(aes(label = n), position = position_stack(vjust = 0.5), color = "white", fontface = "bold", size = 5) +
  
  # Add percentage label to bars 
  geom_text(aes(label = paste0(round(percentage, 1), "%")), hjust = -0.2, vjust = 0.5, size = 5, fontface = "bold") +
  
  # Customize the appearance of the plot
  labs(x = "Route of Exposure", y = "Percentage") +
  theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
        axis.text.x = element_text(size = 15),
        axis.text.y = element_text(size = 15),
        axis.title.x = element_text(size = 15),
        axis.title.y = element_text(size = 15),
        plot.title = element_blank()) +
        coord_flip() + 
        ylim(0, 100)


fig4a
# ggsave(here("figures", "fig4a_pesticide_chemical_count.pdf"), width = 16, height = 10, units = "cm", scale = 2, dpi = 300)
```

# Objective 2. To investigate the study designs employed to assess the effects of pesticide exposure on the behaviour of non-larval zebrafish.

making dosages consistent for dosage comparisons
```{r}
pdo <- pdo %>%
  # Remove rows with NA values
  filter(!is.na(dosage_lowest)) %>%
  # Convert dosage_lowest to numeric and dosage_lowest_unit to character
  mutate(dosage_lowest = as.numeric(dosage_lowest),
         dosage_lowest_unit = as.character(dosage_lowest_unit),
         
         # Standardize dosage_unit_consistent based on dosage_lowest_unit
         dosage_unit_consistent = case_when(
           dosage_lowest_unit == "mg/L" ~ "ug/L",
           dosage_lowest_unit == "ng/L" ~ "ug/L",
           dosage_lowest_unit == "g/L" ~ "ug/L",
           dosage_lowest_unit == "ppb" ~ "ug/L",
           dosage_lowest_unit == "ppm" ~ "ug/L",
           TRUE ~ dosage_lowest_unit),
         
         # Convert dosage_lowest to ug/L based on dosage_lowest_unit
         dosage_lowest_convert_ugL = case_when(
           dosage_lowest_unit == "mg/L" ~ dosage_lowest * 1000,
           dosage_lowest_unit == "ng/L" ~ dosage_lowest / 1000,
           dosage_lowest_unit == "g/L" ~ dosage_lowest/1000000,
           dosage_lowest_unit == "ppb" ~ dosage_lowest * 1000,
           dosage_lowest_unit == "ppm" ~ dosage_lowest/1000,
           TRUE ~ dosage_lowest),
         
         # Convert dosage_highest to numeric and dosage_highest_unit to character
         dosage_highest = as.numeric(dosage_highest),
         
         # Convert dosage_highest to ug/L based on dosage_highest_unit
         dosage_highest_convert_ugL = case_when(
           dosage_highest_unit == "mg/L" ~ dosage_highest * 1000,
           dosage_highest_unit == "ng/L" ~ dosage_highest / 1000,
           dosage_highest_unit == "g/L" ~ dosage_highest/1000000,
           dosage_highest_unit == "ppb" ~ dosage_highest * 1000,
           dosage_highest_unit == "ppm" ~ dosage_highest/1000,
           TRUE ~ dosage_highest))
```


## fig4b - comparison of lowest and highest dosages in waterbourne exposure methods
```{r }
# Pivot the dataset to a longer format, separating out the dosage type (lowest or highest) and value into separate columns
pdo_waterbourne <- pdo %>%
  pivot_longer(cols = c(dosage_lowest, dosage_highest), 
               names_to = "dosage_type",
               values_to = "dosage_value") %>% 
  
  # Filter for waterborne routes with consistent dosage units and a dosage number greater than 1
  filter(route == "waterbourne", dosage_unit_consistent == "ug/L",
         dosage_number > 1) %>%  
  
  # Rename the dosage type column for better labeling in the plot
  mutate(dosage_type = if_else(dosage_type == "dosage_lowest", "Lowest Dosage Exposed", "Highest Dosage Exposed")) 

# Create the plot with dosage type (i.e., lowest or highest dose) on the x-axis and dosage value on the y-axis
fig4b <- ggplot(pdo_waterbourne, aes(x = dosage_type, y = log(dosage_value))) +
  
  # Add a violin plot 
  geom_violin(fill = "#5F85AE", alpha =0.2, color = NA, trim = FALSE) +

  # Add a boxplot 
  geom_boxplot(width = 0.05, fill = "white", color = "#5F85AE", outlier.shape = NA) +

  # Add jittered points .
  geom_jitter(width = 0.1, height = 0.05, color = "#5F85AE", alpha = 0.8) +

  
  # Add axis and plot labels
  labs(title = "Waterborne Exposures by Dosage in ug/L", x = "Waterborne Exposure", y = "log(Dosage (ug/L))") +
  
  # Customize plot theme
  theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
    axis.line.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.text.x = element_text(size = 15),
    axis.text.y = element_text(size = 15),
    axis.title.x = element_text(size = 15),
    axis.title.y = element_text(size = 15),
    plot.title = element_blank())

 # fig4b
# ggsave(here("figures", "fig4_pesticide_dosage.pdf"), width = 16, height = 10, units = "cm", scale = 2, dpi = 300)
```

## figs4 - comparison of lowest and highest dosages of waterbourne exposure to deltamethrin
```{r}
# Pivot the data set to a longer format, separating out the dosage type (lowest or highest) and value into separate columns
pdo_waterbourne_deltamethrin <- pdo %>%
  pivot_longer(cols = c(dosage_lowest, dosage_highest), 
               names_to = "dosage_type",
               values_to = "dosage_value") %>% 
  
  # Filter for waterborne routes with consistent dosage units and only deltamethrin pesticide investigated
  filter(route == "waterbourne", dosage_unit_consistent == "ug/L", pesticide_investigated == "deltamethrin") %>% 

  # Rename the dosage type column for better labeling in the plot
  mutate(dosage_type = if_else(dosage_type == "dosage_lowest", "Lowest Dosage Exposed", "Highest Dosage Exposed"))

# Create the plot with dosage type (i.e., lowest or highest dose) on the x-axis and dosage value on the y-axis
figs4 <- ggplot(pdo_waterbourne_deltamethrin, aes(x = dosage_type, y = log(dosage_value))) +
  
  # Add a violin plot 
  geom_violin(fill = "#5F85AE", alpha = 0.2, color = NA, trim = FALSE) +
  
  # Add a boxplot 
  geom_boxplot(width = 0.05, fill = "white", color = "#5F85AE", outlier.shape = NA) +
  
  # Add jittered points
  geom_jitter(width = 0.1, height = 0.05, color = "#5F85AE", alpha = 0.5) +
  
  # Add axis and plot labels
  labs(title = "Waterborne Exposures of Deltamethrin by Dosage in ug/L", x = "Waterbourne exposure", y = "log(Dosage (ug/L))") +
  
  # Customize plot theme
  theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
        axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(size = 15),
        axis.text.y = element_text(size = 15, hjust = 1),
        axis.title.x = element_text(size = 15),
        axis.title.y = element_text(size = 15),
        plot.title = element_blank())

# figs4
# ggsave(here("figures", "figs4_pesticide_dosage_deltamethrin.pdf"), width = 16, height = 10, units = "cm", scale = 2, dpi = 300)
```

## figs5 - comparison of lowest and highest dosages of waterbourne exposure to rotenone
```{r}
# Pivot the data set to a longer format, separating out the dosage type (lowest or highest) and value into separate columns
pdo_waterbourne_rotenone <- pdo %>%
  pivot_longer(cols = c(dosage_lowest, dosage_highest), 
               names_to = "dosage_type",
               values_to = "dosage_value") %>% 
  
  # Filter for waterborne routes with consistent dosage units and only rotenone pesticide investigated
  filter(route == "waterbourne", dosage_unit_consistent == "ug/L", pesticide_investigated == "rotenone") %>% 
  
  # Rename the dosage type column for better labeling in the plot
  mutate(dosage_type = if_else(dosage_type == "dosage_lowest", "Lowest Dosage Exposed", "Highest Dosage Exposed"))

# Create the plot with dosage type (i.e., lowest or highest dose) on the x-axis and dosage value on the y-axis
figs5 <- ggplot(pdo_waterbourne_rotenone, aes(x = dosage_type, y = log(dosage_value))) +
  
  # Add a violin plot 
  geom_violin(fill = "#5F85AE", alpha = 0.3, trim = FALSE, color = NA) +
  
  # Add a boxplot 
  geom_boxplot(width = 0.05, fill = "white", color = "#5F85AE", outlier.shape = NA) +
  
  # Add jittered points
  geom_jitter(width = 0.1, height = 0.05, color = "#5F85AE", alpha = 0.5) +
  
  # Add axis and plot labels
  labs(title = "Waterborne Exposures of Rotenone by Dosage in ug/L", x = "Waterbourne exposure", y = "log(Dosage (ug/L))") +
  
  # Customize plot theme
  theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
        axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(size = 15),
        axis.text.y = element_text(size = 15, hjust = 1),
        axis.title.x = element_text(size = 15),
        axis.title.y = element_text(size = 15),
        plot.title = element_blank())
# figs5
# ggsave(here("figures", "figs5_pesticide_dosage_rotenone.pdf"), width = 16, height = 10, units = "cm", scale = 2, dpi = 300)

```

## figs6 - comparison of lowest and highest dosages of waterbourne exposure atrazine

```{r}
# Pivot the data set to a longer format, separating out the dosage type (lowest or highest) and value into separate columns
pdo_waterbourne_atrazine <- pdo %>%
  pivot_longer(cols = c(dosage_lowest, dosage_highest), 
               names_to = "dosage_type",
               values_to = "dosage_value") %>% 

  # Filter for waterborne routes with consistent dosage units and only atrazine pesticide investigated
  filter(route == "waterbourne", dosage_unit_consistent == "ug/L", pesticide_investigated == "atrazine") %>%  

  # Rename the dosage type column for better labeling in the plot
  mutate(dosage_type = if_else(dosage_type == "dosage_lowest", "Lowest Dosage Exposed", "Highest Dosage Exposed"))

# Create the plot with dosage type (i.e., lowest or highest dose) on the x-axis and dosage value on the y-axis
figs6 <- ggplot(pdo_waterbourne_atrazine, aes(x = dosage_type, y = log(dosage_value))) +

  # Add a violin plot 
  geom_violin(fill = "#5F85AE", alpha = 0.3, trim = FALSE, color = "NA") +

  # Add a boxplot 
  geom_boxplot(width = 0.05, fill = "white", color = "#5F85AE", outlier.shape = NA) +

  # Add jittered points
  geom_jitter(width = 0.1, height = 0.05, color = "#5F85AE", alpha = 0.5) +

  # Add axis and plot labels
  labs(title = "Waterborne Exposures of Atrazine by Dosage in ug/L", x = "Waterborne exposure", y = "log(Dosage (ug/L))")  +

  # Customize plot theme
  theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
    axis.line.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.text.x = element_text(size = 15),
    axis.text.y = element_text(size = 15, hjust = 1),
    axis.title.x = element_text(size = 15),
    axis.title.y = element_text(size = 15),
    plot.title = element_blank())


# figs6
# ggsave(here("figures", "figs6_pesticide_dosage_atrazine.pdf"), width = 16, height = 10, units = "cm", scale = 2, dpi = 300)

```

## figs7 - comparison to lowest and highest dosages of waterbourne exposure to glyphosate
```{r}
# Pivot the data set to a longer format, separating out the dosage type (lowest or highest) and value into separate columns
pdo_waterbourne_glyphosate <- pdo %>%
  pivot_longer(cols = c(dosage_lowest, dosage_highest), 
               names_to = "dosage_type",
               values_to = "dosage_value") %>% 
  
  # Filter for waterborne routes with consistent dosage units and only glyphosate pesticide investigated
  filter(route == "waterbourne", dosage_unit_consistent == "ug/L", pesticide_investigated == "glyphosate") %>%  
  
  # Rename the dosage type column for better labeling in the plot
  mutate(dosage_type = if_else(dosage_type == "dosage_lowest", "Lowest Dosage Exposed", "Highest Dosage Exposed"))


# Create the plot with dosage type (i.e., lowest or highest dose) on the x-axis and dosage value on the y-axis
figs7 <- ggplot(pdo_waterbourne_glyphosate, aes(x = dosage_type, y = log(dosage_value))) +
  
  # Add a violin plot
 geom_violin(fill = "#5F85AE", alpha = 0.3, trim = FALSE, color = NA) +
  
  # Add a boxplot
  geom_boxplot(width = 0.05, fill = "white", color = "#5F85AE", outlier.shape = NA) +
  
  # Add jittered points
  geom_jitter(width = 0.1, height = 0.05, color = "#5F85AE", alpha = 0.5) +
  
  # Add axis and plot labels
  labs(title = "Waterborne Exposures of Glyphosate by Dosage in ug/L", x = "Waterbourne exposure", y = "log(Dosage (ug/L))")  +
  
  # Customize plot theme
  theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
    axis.line.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.text.x = element_text(size = 15),
    axis.text.y = element_text(size = 15, hjust = 1),
    axis.title.x = element_text(size = 15),
    axis.title.y = element_text(size = 15),
    plot.title = element_blank())

# figs7
# ggsave(here("figures", "figs7_pesticide_dosage_glyphosate.pdf"), width = 16, height = 10, units = "cm", scale = 2, dpi = 300)
```

## figs8  - comparison to lowest and highest dosages of waterbourne exposure to chlopyrifo
```{r}
# Pivot the data set to a longer format, separating out the dosage type (lowest or highest) and value into separate columns
pdo_waterbourne_chloropyrifo <- pdo %>%
  pivot_longer(cols = c(dosage_lowest, dosage_highest), 
               names_to = "dosage_type",
               values_to = "dosage_value") %>% 
  
  # Filter for waterborne routes with consistent dosage units and only glyphosate pesticide investigated
  filter(route == "waterbourne", dosage_unit_consistent == "ug/L", pesticide_investigated == "chloropyrifo") %>%  
  
  # Rename the dosage type column for better labeling in the plot
  mutate(dosage_type = if_else(dosage_type == "dosage_lowest", "Lowest Dosage Exposed", "Highest Dosage Exposed"))

# Create the plot with dosage type (i.e., lowest or highest dose) on the x-axis and dosage value on the y-axis
figs8 <- ggplot(pdo_waterbourne_chloropyrifo, aes(x = dosage_type, y = log(dosage_value))) +
  
  # Add a violin plot
  geom_violin(fill = "#5F85AE", alpha = 0.3, trim = FALSE, color = NA) +
  
  # Add a boxplot
  geom_boxplot(width = 0.05, fill = "white", color = "#5F85AE", outlier.shape = NA) +
  
  # Add jittered points
  geom_jitter(width = 0.1, height = 0.05, color = "#5F85AE", alpha = 0.5) +

  # Add axis and plot labels
  labs(title = "Waterborne Exposures of Chloropyrifos by Dosage in ug/L", x = "Waterbourne exposure", y = "log(Dosage (ug/L))")  +
  
  # Customize plot theme
  theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
    axis.line.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.text.x = element_text(size = 15),
    axis.text.y = element_text(size = 15, hjust = 1),
    axis.title.x = element_text(size = 15),
    axis.title.y = element_text(size = 15),
    plot.title = element_blank())

# figs8
# ggsave(here("figures", "figs8_pesticide_dosage_chloropyrifo.pdf"), width = 16, height = 10, units = "cm", scale = 2, dpi = 300)
```

## fig4c - durations of waterbourne exposure 

```{r}

pdo <- pdo %>% 
  filter(!is.na(duration)) %>%
  # Convert duration to numeric and duration_unit to character 
  mutate(duration = as.numeric(duration),
         duration_unit = as.character(duration_unit),
         
  # Standardize duration_unit_consistent based on dosage_unit 
  duration_unit_consistent = case_when(
          duration_unit == "minutes" ~ "hours",
        
          duration_unit == "days" ~ "hours",
          duration_unit == "weeks" ~ "hours",
           TRUE ~ duration_unit),
  
  # Convert duration to hours based on duration_unit
  
  duration_convert = case_when(
    duration_unit == "minutes" ~ duration* 60,
    duration_unit == "days" ~ duration/24, 
    duration_unit == "weeks" ~ duration/168,
    TRUE ~ duration)) %>% 
  filter(route == "waterbourne")
  

fig4c <- ggplot(pdo, aes(x = route , y = log(duration))) + 
    # Add a violin plot 
  geom_violin(fill = "#5F85AE", alpha =0.2, color = NA, trim = FALSE) +

  # Add a boxplot 
  geom_boxplot(width = 0.05, fill = "white", color = "#5F85AE", outlier.shape = NA) +

  # Add jittered points 
  geom_jitter(width = 0.1, height = 0.05, color = "#5F85AE", alpha = 0.8) +

  
  # Add axis and plot labels
  labs(x = "Route ", y = "log(duration (hours))") +
  
  # Customize plot theme
  theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
    axis.line.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.text.x = element_text(size = 15),
    axis.text.y = element_text(size = 15),
    axis.title.x = element_text(size = 15),
    axis.title.y = element_text(size = 15),
    plot.title = element_blank())

# fig4c
# ggsave(here("figures", "fig4c_pesticide_duration_exposure.pdf"), width = 16, height = 10, units = "cm", scale = 2, dpi = 300)
```


```{r}
# Combine three plots into a single plot using a grid layout
fig4 <- ((fig4b | fig4c) / (fig4a)  + plot_annotation(tag_levels = "A"))

fig4
#ggsave(here("figures", "fig3_pesticide_study_design.pdf"), width = 16, height = 10, units = "cm", scale = 2, dpi = 300)
```

## figs9 - total lifestage of exposure completed as a percentage
```{r}

# Calculate total count for each category
total_count_lse <- sd %>% count(life_stage_exposure)

# Calculate proportion and percentage for each category
life_stage_pct <- sd %>%
    separate_rows(life_stage_exposure, sep = ",\\s*") %>% 
  count(life_stage_exposure) %>%
  mutate(proportion = n/sum(total_count_lse$n),
         percentage = proportion*100)

 # Create a bar chart with the count on the x-axis and life stage of exposure  on the y-axis
figs9 <- ggplot(life_stage_pct, aes(x = reorder(life_stage_exposure, percentage), y = percentage)) +
  
  # Customize the appearance of the bars 
   geom_bar(stat = "identity", fill = "#5F85AE", color = "white", alpha = 0.8, position = position_dodge(0.9)) +
  
  # Add labels to the bars for percentage 
  geom_text(aes(label = paste0(round(percentage, 1), "%")), hjust = -0.2, vjust = 0.5, size = 5, fontface = "bold") +
  
   # Add absolute count to bars
  geom_text(aes(label = n), position = position_stack(vjust = 0.5), color = "white", fontface = "bold", size = 5) +
  
  # Add axis and plot labels 
  labs( x = "Life Stage of Exposure", y = "Percentage", fontsize = 14) +
  
  # Customize the plot theme 
  theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
    axis.line.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.text.x = element_text(size = 15),
    axis.text.y = element_text(size = 15, hjust = 1),
    axis.title.x = element_text(size = 15),
    axis.title.y = element_text(size = 15),
    plot.title = element_blank()) +
  coord_flip() + 
  ylim(0, 100)

figs9
# ggsave(here("figures", "figs9_life_stage_exposure.pdf"), width = 16, height = 10, units = "cm", scale = 2, dpi = 300)
```

## figs10 - total lifestage of behaviour completed as a percentage
```{r}
# Calculate total count for each category
total_count_lsb <- sd %>% count(life_stage_behaviour)

# Calculate proportion and percentage for each category
life_stage_pct <- sd %>%
  separate_rows(life_stage_behaviour, sep = ",\\s*") %>% 
  count(life_stage_behaviour) %>%
  mutate( proportion = n / sum(total_count_lsb$n),
    percentage = proportion * 100)

# Create a bar chart with the count on the x-axis and life stage of behavior on the y-axis
figs10 <- ggplot(life_stage_pct, aes(x = reorder(life_stage_behaviour, percentage), y = percentage)) +
  
  # Customize the appearance of the bars 
  geom_bar(stat = "identity", fill = "#5F85AE", color = "white", alpha = 0.8,position = position_dodge(0.9)) +
  
  # Add labels to the bars for percentage 
  geom_text(aes(label = paste0(round(percentage, 1), "%")), hjust = -0.2, vjust = 0.5, size = 5, fontface = "bold") +
  
  # Add absolute count to bars
  geom_text(aes(label = n), position = position_stack(vjust = 0.5), color = "white",fontface = "bold", size = 5) +
  
  # Add axis and plot labels 
  labs(x = "Life Stage of Behavior", y = "Percentage", fontsize = 14) +
  
  # Customize the plot theme 
  theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
    axis.line.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.text.x = element_text(size = 15),
    axis.text.y = element_text(size = 15, hjust = 1),
    axis.title.x = element_text(size = 15),
    axis.title.y = element_text(size = 15),
    plot.title = element_blank()) +
  coord_flip() + 
  ylim(0, 100)

# figs10
# ggsave(here("figures", "figs10_life_stage_behaviour.pdf"), width = 16, height = 10, units = "cm", scale = 2, dpi = 300)
```

## figs11  - total sexes exposed 
```{r}
# Calculate total count for each category
total_sex_count <- sd %>% count(sex)

# Calculate proportion and percentage for each category
sex_pct <- sd %>%
  count(sex) %>%
  mutate(proportion = n/sum(total_sex_count$n),
         percentage = proportion*100)

# Create a bar chart with the count  on the x-axis and behaviorual class on the y-axis
figs11 <- ggplot(sex_pct, aes(x = reorder(sex, percentage), y = percentage)) +
  
  # Customize the appearance of the bars 
  geom_bar(stat = "identity", fill = "#5F85AE", color = "white", alpha = 0.8, position = position_dodge(0.9)) +
  
  # Add labels to the bars for percentage 
  geom_text(aes(label = paste0(round(percentage, 1), "%")), hjust = -0.2, vjust = 0.5, size = 5, fontface = "bold") +
  
  # Add absolute count to bars
  geom_text(aes(label = n), position = position_stack(vjust = 0.5), color = "white", fontface = "bold", size = 5) +
  
  # Add axis and plot labels 
  labs(x = "Sex of Exposure", y = "Percentage") +
  
  # Customize the plot theme 
   theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
    axis.line.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.text.x = element_text(size = 15),
    axis.text.y = element_text(size = 15, hjust = 1),
    axis.title.x = element_text(size = 15),
    axis.title.y = element_text(size = 15),
    plot.title = element_blank()) +
  coord_flip() + 
  ylim(0, 100)

# figs11
# ggsave(here("figures", "figs11_total_sex_exposed.pdf"), width = 16, height = 10, units = "cm", scale = 2, dpi = 300)
```


# Objective 3.	To identify the specific behaviours that have been investigated in pesticide exposure experiments that use zebrafish as a model.

## fig5 - total number of studies investigating each broad behaviour class
```{r}

# Calculate total count for each category
total_behaviour_class_count <- bd %>% 
  separate_rows(behavioural_class, sep = ",\\s*") %>%  
  count(behavioural_class)

# Calculate proportion and percentage for each category
behav_class_pct <- total_behaviour_class_count %>%
  mutate(proportion = n/sum(total_behaviour_class_count$n),
         percentage = proportion*100)

# Create a bar chart with the count on the x-axis and Behavioural class  assay on the y-axis
 fig5 <-  ggplot(behav_class_pct, aes(x = reorder(behavioural_class, percentage), y = percentage)) +
    
  # Customize the appearance of the bars 
  geom_bar(stat = "identity", fill = "#5F85AE", color = "white", alpha = 0.8, position = position_dodge(0.9)) +
    
  # Add labels to the bars for percentage 
  geom_text(aes(label = paste0(round(percentage, 1), "%")), hjust = -0.2, vjust = 0.5, size = 5, fontface = "bold", color = "black") +
    
  # Add labels to the bars for absolute count  
  geom_text(aes(label = n), position = position_stack(vjust = 0.5), color = "white", size = 5, hjust = 0.5, fontface = "bold") +
    
  # Add axis and plot labels
  labs(x = "Behavioural Class", y = "Percentage") +
    
  # Customize the plot theme 
  theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
    axis.line.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.text.x = element_text(size = 15),
    axis.text.y = element_text(size = 15, hjust = 1),
    axis.title.x = element_text(size = 15),
    axis.title.y = element_text(size = 15),
    plot.title = element_blank()) +
   coord_flip() + 
   ylim(0, 50)
  
  
# fig5
# ggsave(here("figures", "figs12_behaviour_class_count.pdf"), width = 16, height = 10, units = "cm", scale = 2, dpi = 300)
```


## figs12 - total number of studies investigating each behavioural assay of behaviour activity
```{r}
# Calculate count for each assay in behavioral activity 
total_behaviour_activity_count <- bd %>% 
  separate_rows(behaviour_activity, sep = ",\\s*") %>%  
  count(behaviour_activity) %>% 
  na.omit()

# Calculate proportion and percentage for each category
behav_activity_pct <- total_behaviour_activity_count %>%
  mutate(proportion = n/sum(total_behaviour_activity_count$n),
         percentage = proportion*100)

# Create a bar chart with the count on the x-axis and Behavioural activity assay on the y-axis
figs12 <-  ggplot(behav_activity_pct, aes(x = reorder(behaviour_activity, n), y = percentage)) +
  
  # Customize the appearance of the bars 
  geom_bar(stat = "identity", fill = "#5F85AE", color = "white", alpha = 0.8, position = position_dodge(0.9)) +
  
 # Add labels to the bars for percentage 
  geom_text(aes(label = paste0(round(percentage, 1), "%")), hjust = -0.2, vjust = 0.5, size = 5, fontface = "bold",     color = "black") +
    
  # Add labels to the bars for absolute count  
  geom_text(aes(label = n), position = position_stack(vjust = 0.5), color = "white", size = 5, hjust = 0.5, fontface =   "bold") +
  
  # Add axis and plot labels
  labs(x = "Activity Assay", y = "Percentage") +
  
  # Customize the plot theme
  theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
    axis.line.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.text.x = element_text(size = 15),
    axis.text.y = element_text(size = 15, hjust = 1),
    axis.title.x = element_text(size = 15),
    axis.title.y = element_text(size = 15),
    plot.title = element_blank()) +
    coord_flip() +
  ylim(0, 100)

# figs12
#ggsave(here("figures", "figs12_behaviour_activity.pdf"), width = 16, height = 10, units = "cm", scale = 2, dpi = 300)
```

## figs13 - total number of studies investigating each behavioural assay of behaviour_aggression
```{r}
# Calculate count for each assay in aggression behavior
total_behaviour_aggression_count <- bd %>% 
  separate_rows(behaviour_aggression, sep = ",\\s*") %>%  
  count(behaviour_aggression) %>% 
  na.omit()

# Calculate proportion and percentage for each category
behav_aggression_pct <- total_behaviour_aggression_count %>%
  mutate(proportion = n/sum(total_behaviour_aggression_count$n),
         percentage = proportion*100)

# Create a bar chart with the count on the x-axis and aggression behavior assay on the y-axis
figs13 <-  ggplot(behav_aggression_pct, aes(x = reorder(behaviour_aggression, n), y = percentage)) +
  
  # Customize the appearance of the bars 
  geom_bar(stat = "identity", fill = "#5F85AE", color = "white", alpha = 0.8, position = position_dodge(0.9)) +
  
 # Add labels to the bars for percentage 
  geom_text(aes(label = paste0(round(percentage, 1), "%")), hjust = -0.2, vjust = 0.5, size = 5, fontface = "bold",     color = "black") +
    
  # Add labels to the bars for absolute count  
  geom_text(aes(label = n), position = position_stack(vjust = 0.5), color = "white", size = 5, hjust = 0.5, fontface =   "bold") +
  
  # Add axis and plot labels
  labs(x = "Aggression Behavior Assay", y = "Percentage") +
  
  # Customize the plot theme
  theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
    axis.line.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.text.x = element_text(size = 15),
    axis.text.y = element_text(size = 15, hjust = 1),
    axis.title.x = element_text(size = 15),
    axis.title.y = element_text(size = 15),
    plot.title = element_blank()) +
    coord_flip() +
  ylim(0, 120)

figs13
# ggsave(here("figures", "figs13_behaviour_aggression.pdf"), width = 16, height = 10, units = "cm", scale = 2, dpi = 300)
```

## figs14 - total number of studies investigating each behavioural assay of behavioural_sociality
```{r}
# Calculate count for each assay in social behavior
total_behaviour_sociality_count <- bd %>% 
  separate_rows(behaviour_sociality, sep = ",\\s*") %>%  
  count(behaviour_sociality) %>% 
  na.omit()

# Calculate proportion and percentage for each category
behav_sociality_pct <- total_behaviour_sociality_count %>%
  mutate(proportion = n/sum(total_behaviour_sociality_count$n),
         percentage = proportion*100)

# Create a bar chart with the count on the x-axis and social behavior assay on the y-axis
figs14 <-  ggplot(behav_sociality_pct, aes(x = reorder(behaviour_sociality, n), y = percentage)) +
  
  # Customize the appearance of the bars 
  geom_bar(stat = "identity", fill = "#5F85AE", color = "white", alpha = 0.8, position = position_dodge(0.9)) +
  
 # Add labels to the bars for percentage 
  geom_text(aes(label = paste0(round(percentage, 1), "%")), hjust = -0.2, vjust = 0.5, size = 5, fontface = "bold",     color = "black") +
    
  # Add labels to the bars for absolute count  
  geom_text(aes(label = n), position = position_stack(vjust = 0.5), color = "white", size = 5, hjust = 0.5, fontface =   "bold") +
  
  # Add axis and plot labels
  labs(x = "Social Behavior Assay", y = "Percentage") +
  
  # Customize the plot theme
  theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
    axis.line.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.text.x = element_text(size = 15),
    axis.text.y = element_text(size = 15, hjust = 1),
    axis.title.x = element_text(size = 15),
    axis.title.y = element_text(size = 15),
    plot.title = element_blank()) +
    coord_flip() +
    ylim(0, 100)

# figs14
# ggsave(here("figures", "figs14_behaviour_sociality.pdf"), width = 16, height = 10, units = "cm", scale = 2, dpi = 300)

```

## figs15 - total number of studies investigating each behavioural assay of behavioural_foraging
```{r}
# Calculate count for each assay in foraging behavior
total_behaviour_foraging_count <- bd %>% 
  separate_rows(behaviour_foraging, sep = ",\\s*") %>%  
  count(behaviour_foraging) %>% 
  na.omit()

# Calculate proportion and percentage for each category
behav_foraging_pct <- total_behaviour_foraging_count %>%
  mutate(proportion = n/sum(total_behaviour_foraging_count$n),
         percentage = proportion*100)

# Create a bar chart with the count on the x-axis and foraging behavior assay on the y-axis
figs15 <-  ggplot(behav_foraging_pct, aes(x = reorder(behaviour_foraging, n), y = percentage)) +
  
  # Customize the appearance of the bars 
  geom_bar(stat = "identity", fill = "#5F85AE", color = "white", alpha = 0.8, position = position_dodge(0.9)) +
  
 # Add labels to the bars for percentage 
  geom_text(aes(label = paste0(round(percentage, 1), "%")), hjust = -0.2, vjust = 0.5, size = 5, fontface = "bold",     color = "black") +
    
  # Add labels to the bars for absolute count  
  geom_text(aes(label = n), position = position_stack(vjust = 0.5), color = "white", size = 5, hjust = 0.5, fontface =   "bold") +
  
  # Add axis and plot labels
  labs(x = "Foraging Behavior Assay", y = "Percentage") +
  
  # Customize the plot theme
  theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
    axis.line.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.text.x = element_text(size = 15),
    axis.text.y = element_text(size = 15, hjust = 1),
    axis.title.x = element_text(size = 15),
    axis.title.y = element_text(size = 15),
    plot.title = element_blank()) +
    coord_flip() +
    ylim(0, 100)

# figs15
# ggsave(here("figures", "figs15_behaviour_foraging.pdf"), width = 16, height = 10, units = "cm", scale = 2, dpi = 300)

```

## figs16 - total number of studies investigating each behavioural assay of anti-predator behaviour
```{r}
# Calculate count for each assay in antipredator behavior
total_behaviour_antipredator_count <- bd %>% 
  separate_rows(behaviour_antipredator, sep = ",\\s*") %>%  
  count(behaviour_antipredator) %>% 
  na.omit()

# Calculate proportion and percentage for each category
behav_antipredator_pct <- total_behaviour_antipredator_count %>%
  mutate(proportion = n/sum(total_behaviour_antipredator_count$n),
         percentage = proportion*100)

# Create a bar chart with the count on the x-axis and antipredator behavior assay on the y-axis
figs16 <- ggplot(behav_antipredator_pct, aes(x = reorder(behaviour_antipredator, n), y = percentage)) +
  
  # Customize the appearance of the bars 
  geom_bar(stat = "identity", fill = "#5F85AE", color = "white", alpha = 0.8, position = position_dodge(0.9)) +
  
  # Add labels to the bars for percentage 
  geom_text(aes(label = paste0(round(percentage, 1), "%")), hjust = -0.2, vjust = 0.5, size = 5, fontface = "bold", color = "black") +
    
  # Add labels to the bars for absolute count  
  geom_text(aes(label = n), position = position_stack(vjust = 0.5), color = "white", size = 5, hjust = 0.5, fontface = "bold") +
  
  # Add axis and plot labels
  labs(x = "Antipredator Behavior Assay", y = "Percentage") +
  
  # Customize the plot theme
  theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
        axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(size = 15),
        axis.text.y = element_text(size = 15, hjust = 1),
        axis.title.x = element_text(size = 15),
        axis.title.y = element_text(size = 15),
        plot.title = element_blank()) +
  coord_flip() +
  ylim(0, 100)

figs16
# ggsave(here("figures", "figs16_behaviour_antipredator.pdf"), width = 16, height = 10, units = "cm", scale = 2, dpi = 300)

```

## figs17 - total number of studies investigating each behavioural assay of Anxiety or Boldness behaviour
```{r}
# Calculate count for each assay in anxiety behavior
total_behaviour_anxiety_count <- bd %>% 
  separate_rows(behaviour_anxiety, sep = ",\\s*") %>%  
  count(behaviour_anxiety) %>% 
  na.omit()

# Calculate proportion and percentage for each category
behav_anxiety_pct <- total_behaviour_anxiety_count %>%
  mutate(proportion = n/sum(total_behaviour_anxiety_count$n),
         percentage = proportion*100)

# Create a bar chart with the count on the x-axis and anxiety behavior assay on the y-axis
figs17 <- ggplot(behav_anxiety_pct, aes(x = reorder(behaviour_anxiety, n), y = percentage)) +
  
  # Customize the appearance of the bars 
  geom_bar(stat = "identity", fill = "#5F85AE", color = "white", alpha = 0.8, position = position_dodge(0.9)) +
  
  # Add labels to the bars for percentage 
  geom_text(aes(label = paste0(round(percentage, 1), "%")), hjust = -0.2, vjust = 0.5, size = 5, fontface = "bold", color = "black") +
    
  # Add labels to the bars for absolute count  
  geom_text(aes(label = n), position = position_stack(vjust = 0.5), color = "white", size = 5, hjust = 0.5, fontface = "bold") +
  
  # Add axis and plot labels
  labs(x = "Anxiety Behavior Assay", y = "Percentage") +
  
  # Customize the plot theme
  theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
        axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(size = 15),
        axis.text.y = element_text(size = 15, hjust = 1),
        axis.title.x = element_text(size = 15),
        axis.title.y = element_text(size = 15),
        plot.title = element_blank()) +
        coord_flip() +
        ylim(0, 80)

figs17
# ggsave(here("figures", "figs17_behaviour_anxiety.pdf"), width = 16, height = 10, units = "cm", scale = 2, dpi = 300)

```


## figs18 - heat map to show which behavours have been investigated in which pesticide target class
```{r}
# Join the behaviour details and pesticide details by "study_id"
bd_pd <- left_join(bd, pd, by = "study_id")

# Separate rows in "bd_pd" by "behavioural_class" and "pesticide_target_class" columns
bd_pd1 <- separate_rows(bd_pd, behavioural_class, sep = ",\\s*", convert = TRUE)
bd_pd1<- separate_rows(bd_pd1, pesticide_target_class, sep = ",\\s*", convert = TRUE)

# Group by "behavioural_class" and "pesticide_target_class" and summarize count
bd_pd_summary1 <- bd_pd1 %>%
  mutate(behavioural_class = str_trim(behavioural_class),
         pesticide_target_class = str_trim(pesticide_target_class)) %>%
  group_by(behavioural_class, pesticide_target_class) %>%
  summarise(count = n()) %>%
  ungroup() 

# Create a heatmap with pesticide target class on the x-axis and behavioural class on the y-axis
figs18 <- ggplot(bd_pd_summary1, aes(x = pesticide_target_class, y = behavioural_class, fill = count)) +
  
  #Create and fill each tile 
  geom_tile(color = "white") +
  scale_fill_gradient(low = "#F0F4F8", high = "#446487") +
  
  # Add labels to the bars for absolute count  
  geom_text(aes(label = count), color = "black", size = 4) + 
  
  # Add axis and plot labels
  labs(x = "Pesticide Target Class", y = "Behavioural Class", fill = "Count") +
  
  # Customize the plot theme
  theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
        axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(size = 15),
        axis.text.y = element_text(size = 15, hjust = 1),
        axis.title.x = element_text(size = 15),
        axis.title.y = element_text(size = 15),
        plot.title = element_blank())


figs18
```

## figs19 - heat map to show which behavours have been investigated in which pesticide chemical class
```{r}
# Separate rows by behavioural_class and pesticide_chemical_class columns
bd_pd2 <- separate_rows(bd_pd, behavioural_class, sep = ",\\s*", convert = TRUE)
bd_pd2 <- separate_rows(bd_pd2, pesticide_chemical_class, sep = ",", convert = TRUE)

# Get the top 3 most numerous pesticide chemical classes
bd_pd_summary2 <- bd_pd2 %>%
  mutate(behavioural_class = str_trim(behavioural_class),
         pesticide_target_class = str_trim(pesticide_chemical_class)) %>%
  group_by(behavioural_class, pesticide_chemical_class) %>%
  summarise(count = n()) %>%
  ungroup() 

top_pesticide_classes <- bd_pd_summary2 %>%
  filter(!is.na(pesticide_chemical_class)) %>%
  group_by(pesticide_chemical_class) %>%
  summarise(count = sum(count)) %>%
  ungroup() %>%
  top_n(3, count) %>% 
  pull(pesticide_chemical_class)

# Subset the data to include only the top 3 classes
bd_pd_summary_top3 <- bd_pd_summary2 %>%
  filter(pesticide_chemical_class %in% top_pesticide_classes)

# Create a heatmap with pesticide chemical class on the x-axis and behavioral class on the y-axis
figs19 <- ggplot(bd_pd_summary_top3, aes(x = pesticide_chemical_class, y = behavioural_class, fill = count)) +
  
  #Create and fill each tile 
  geom_tile(color = "white") +
  scale_fill_gradient(low = "#F0F4F8", high = "#446487") +
  
  # Add labels to the bars for absolute count 
  geom_text(aes(label = ifelse(count > 0, count, "")), color = "black", size = 4) +  
  
  # Add axis and plot labels
  labs(x = "Pesticide Chemical Class", y = "Behavioural Class", fill = "Count") +
  
  # Customize the plot theme
  theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
    axis.line.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.text.x = element_text(size = 15),
    axis.text.y = element_text(size = 15, hjust = 1),
    axis.title.x = element_text(size = 15),
    axis.title.y = element_text(size = 15),
    plot.title = element_blank())
figs19

```

## figs20 - heat map to show which life stages of exposure have been exposed to each pesticide chemical class
```{r}

# Join the stydt details with pesticide details by "study_id". 
sd_pd <- left_join(sd, pd, by = "study_id")

# Separate rows in "sd_pd" by "life_stage_exposure" and "pesticide_chemical_class" columns
sd_pd1 <- separate_rows(sd_pd, life_stage_exposure, sep = ",", convert = TRUE)
sd_pd1 <- separate_rows(sd_pd1, pesticide_chemical_class, sep = ",", convert = TRUE)

# Group by "life_stage_exposure" and "pesticide_chemical_class" and summarize count
sd_pd_summary1 <- sd_pd1 %>%
  mutate(life_stage_exposure = str_trim(life_stage_exposure),
         pesticide_chemical_class = str_trim(pesticide_chemical_class)) %>%
  group_by(life_stage_exposure, pesticide_chemical_class) %>%
  summarise(count = n()) %>%
  ungroup()

top_pesticide_classes <- sd_pd_summary1 %>%
  filter(!is.na(pesticide_chemical_class)) %>%
  group_by(pesticide_chemical_class) %>%
  summarise(count = sum(count)) %>%
  ungroup() %>%
  top_n(4, count) %>%
  pull(pesticide_chemical_class)

sd_pd_summary1_top5 <- sd_pd_summary1 %>%
  filter(pesticide_chemical_class %in% top_pesticide_classes)

# Create a heatmap with pesticide target class on the x-axis and behavioural class on the y-axis
figs20 <- ggplot(sd_pd_summary1_top5, aes(x = pesticide_chemical_class, y = life_stage_exposure, fill = count)) +
  
  #Create and fill each tile
  geom_tile(color = "white") +
  scale_fill_gradient(low = "#F0F4F8", high = "#446487") +
  
  # Add labels to the bars for absolute count 
  geom_text(aes(label = ifelse(count > 0, count, "")), color = "black", size = 4) +
  
  # Add axis and plot labels
  labs(x = "Pesticide Chemical Class", y = "Life Stage Exposure", fill = "Count") +
  
  # Customize the plot theme
  theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
    axis.line.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.text.x = element_text(size = 15),
    axis.text.y = element_text(size = 15, hjust = 1),
    axis.title.x = element_text(size = 15),
    axis.title.y = element_text(size = 15),
    plot.title = element_blank())

figs20
```

## figs21 - heat map to show which life stages of exposure have been exposed to each target chemical class
```{r}

# Separate rows by life_stage_exposure and pesticide_target_class columns
sd_pd2 <- separate_rows(sd_pd, life_stage_exposure, sep = ",", convert = TRUE)
sd_pd2 <- separate_rows(sd_pd2, pesticide_target_class, sep = ",", convert = TRUE)

# Group by "life_stage_exposure" and "pesticide_target_class" and summarize count
sd_pd_summary2 <- sd_pd2 %>%
  mutate(life_stage_exposure = str_trim(life_stage_exposure),
         pesticide_target_class = str_trim(pesticide_target_class)) %>%
  group_by(life_stage_exposure, pesticide_target_class) %>%
  summarise(count = n()) %>%
  ungroup()

# Create a heatmap with pesticide target class on the x-axis and life stage exposure on the y-axis
figs21 <- ggplot(sd_pd_summary2, aes(x = pesticide_target_class, y = life_stage_exposure, fill = count)) +
  
  #Create and fill each tile
  geom_tile(color = "white") +
  scale_fill_gradient(low = "#F0F4F8", high = "#446487") +
  
  # Add labels to the bars for absolute count 
  geom_text(aes(label = ifelse(count > 0, count, "")), color = "black", size = 4) +
  
  # Add axis and plot labels
  labs(x = "Pesticide Target Class", y = "Life Stage Exposure", fill = "Count") +
  
  # Customize the plot theme
  theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
    axis.line.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.text.x = element_text(size = 15),
    axis.text.y = element_text(size = 15, hjust = 1),
    axis.title.x = element_text(size = 15),
    axis.title.y = element_text(size = 15),
    plot.title = element_blank())
figs21                                     

```


# Objective 4. To examine how are authors connected between countries and how is the literature connected between and within disciplines.

## figs24 - general bibliometric summaries
```{r}
# Perform bibliometric analysis on dataset "bib_sco"
figs24 <- biblioAnalysis(bib_sco)

# Display the plot of the analysis results
plot(figs24)

```

## figs27 - co-occurance matrix
```{r}
# Generate a bibliometric network based on co-occurrences of keywords in the "bib_sco" dataset
NetMatrix_keywords <- biblioNetwork(bib_sco, analysis = "co-occurrences", network = "keywords", sep = ";")

# Plot the network using the "networkPlot" function, with various formatting options
figs25 <- networkPlot(NetMatrix_keywords, normalize="association", n = 10, 
                     Title = "Keyword Co-occurrences", type = "fruchterman", 
                     size.cex = TRUE, size = 10, remove.multiple = F, 
                     edgesize = 4, labelsize = 3, label.cex = TRUE, 
                     edges.min = 2, label.n = 10, alpha = 0.3)
 
```

## fig s26 - thematic map based on keywords
```{r}
# Set plot parameters to display a single plot with narrow margins
par(mfrow=c(1,1), mar=c(0,2,0,2))

# Generate a thematic map of the "bib_sco" dataset, using the "ID" field as the basis for the map
figs26 <- thematicMap(bib_sco, field = "ID", n = 1000, minfreq = 5, stemming = FALSE, size = 0.5, n.labels = 1, repel = TRUE)

# Display the resulting map using the "plot" function
plot(figs26$map)


```

## fig6 - country publications map
```{r}

# Extract country information from the "AU1_CO" and "AU_CO" fields of the "bib_sco" dataset
bibmap <- metaTagExtraction(bib_sco, Field = "AU1_CO", sep = ";") 
bibmap <- metaTagExtraction(bibmap, Field = "AU_CO", sep = ";") 

# Create a data frame with counts of articles from each country
bibmap %>% 
  group_by(AU1_CO) %>% 
  count() %>% 
  filter(!is.na(AU1_CO)) -> firstcountrycounts

# Load world map data and remove countries with longitude >180 to make an equal projection-like map
world_map <- map_data("world") %>% 
  filter(! long > 180)

# Format country names to match regions on the world map
firstcountrycounts$region <- str_to_title(firstcountrycounts$AU1_CO)
firstcountrycounts$region[firstcountrycounts$region == "Usa"] <- "USA" 
firstcountrycounts$region[firstcountrycounts$region == "Korea"] <- "South Korea"

# Join count data with map data and set missing counts to zero
emptymap <- tibble(region = unique(world_map$region), n = rep(0,length(unique(world_map$region))))
fullmap <- left_join(emptymap, firstcountrycounts, by = "region")
fullmap$n <- fullmap$n.x + fullmap$n.y
fullmap$n[is.na(fullmap$n)] <- 0

# Create a plot of the world map with regions colored based on article counts
figs27 <- fullmap %>% 
  ggplot(aes(fill = n, map_id = region)) +
  geom_map(map = world_map) +
  expand_limits(x = world_map$long, y = world_map$lat) +
  coord_map("moll") + # Mollweide projection
  theme_map(line_size = 0.5) + 
  scale_fill_gradient(low = "#ECF207", high = "#C307F2", # set color gradient
                    name = "Score", na.value = "gray",
                    limits = c(0.1, 24),
                    guide = guide_colorbar(direction = "vertical.",
                                           barwidth = unit(15, units = "mm"), 
                                           barheight = unit(50, units = "mm"))) +
  guides(fill = guide_colourbar()) +
  theme(panel.background = element_rect(fill = "transparent", colour = NA),
        plot.background = element_rect(fill = "transparent", colour = NA))
  
figs27
# ggsave(here("figures", "world_map.png"), width = 16, height = 10, units = "cm", scale = 2, dpi = 300)
```

## figs28 - country collaboration network circle plot
```{r}
# Extract countries from the affiliations
bib_sco2 <- metaTagExtraction(bib_sco, Field = "AU_CO", sep = ";")

# Create a network matrix of collaborations between countries
NetMatrix_country <- biblioNetwork(bib_sco2, analysis = "collaboration", network = "countries", sep = ";")

# Convert the network matrix to a standard matrix
NetMatrix_country <- as.matrix(NetMatrix_country)

# Remove the lower triangle (as this is duplication of info)
NetMatrix_country[lower.tri(NetMatrix_country)] <- 0 

# Change column and row names to title case
colnames(NetMatrix_country) <- str_to_title(colnames(NetMatrix_country))
rownames(NetMatrix_country) <- str_to_title(rownames(NetMatrix_country))

# Change "Usa" to "USA"
colnames(NetMatrix_country)[colnames(NetMatrix_country) == "Usa"] <- "USA"
rownames(NetMatrix_country)[rownames(NetMatrix_country) == "Usa"] <- "USA"

# Change "United Kingdom" to "UK" for easier plotting
colnames(NetMatrix_country)[colnames(NetMatrix_country) == "United Kingdom"] <- "UK"
rownames(NetMatrix_country)[rownames(NetMatrix_country) == "United Kingdom"] <- "UK"

my.cols2 <- c(
  USA = "#e41a1c",
  Canada = "#377eb8",
  Mexico = "#4daf4a",
  Brazil = "#984ea3",
  Ecuador = "#ff7f00",
  Chile = "#ffff33",
  Philippines = "#a65628",
  China = "#f781bf",
  Korea = "#e41a1c",
  India = "#984ea3",
  Turkey = "#ff7f00",
  Romania = "#4daf4a",
  Switzerland = "#377eb8",
  Norway = "#1b9e77",
  Netherlands = "#d95f02",
  Germany = "#7570b3",
  France = "#e7298a",
  Italy = "#66a61e",
  Portugal = "#e6ab02",
  Spain = "#a6761d",
  Sweden = "#666666"
)

 

# Create a chord diagram of the network matrix
figs28 <- chordDiagram(NetMatrix_country, annotationTrack = "grid", preAllocateTracks = 1, grid.col = my.cols2)

# Add a track to label each sector with its name
circos.trackPlotRegion(track.index = 1, panel.fun = function(x, y) {
  xlim = get.cell.meta.data("xlim")
  ylim = get.cell.meta.data("ylim")
  sector.name = get.cell.meta.data("sector.index")
  circos.text(mean(xlim), ylim[1] + .1, sector.name, facing = "clockwise", niceFacing = TRUE, adj = c(0, 0.5))
  circos.axis(h = "top", labels.cex = 0.5, major.tick.length = 0.2, sector.index = sector.name, track.index = 2)
}, bg.border = NA)

```

## fig6a collaboration matrix with self citation removed
```{r}
# Making diagnol zero to remove self citations 
diag(NetMatrix_country) <- 0

# Create a chord diagram of the network matrix
fig6a <- chordDiagram(NetMatrix_country, annotationTrack = "grid", preAllocateTracks = 1, grid.col = my.cols2)

# Add a track to label each sector with its name
circos.trackPlotRegion(track.index = 1, panel.fun = function(x, y) {
  xlim = get.cell.meta.data("xlim")
  ylim = get.cell.meta.data("ylim")
  sector.name = get.cell.meta.data("sector.index")
  circos.text(mean(xlim), ylim[1] + .1, sector.name, facing = "clockwise", niceFacing = TRUE, adj = c(0, 0.5))
  circos.axis(h = "top", labels.cex = 0.5, major.tick.length = 0.2, sector.index = sector.name, track.index = 2)
}, bg.border = NA)
```

## fig6b continent collaboration 
```{r}
NetMatrix_continent <- NetMatrix_country
# Change "Usa" to "North America"
colnames(NetMatrix_continent)[colnames(NetMatrix_continent) == "USA"] <- "North America"
rownames(NetMatrix_continent)[rownames(NetMatrix_continent) == "USA"] <- "North America"
# Change "Usa" to "North America"
colnames(NetMatrix_continent)[colnames(NetMatrix_continent) == "Canada"] <- "North America"
rownames(NetMatrix_continent)[rownames(NetMatrix_continent) == "Canada"] <- "North America"
# Change "Mexico" to "North America"
colnames(NetMatrix_continent)[colnames(NetMatrix_continent) == "Mexico"] <- "North America"
rownames(NetMatrix_continent)[rownames(NetMatrix_continent) == "Mexico"] <- "North America"
# Change China to Asia
colnames(NetMatrix_continent)[colnames(NetMatrix_continent) == "China"] <- "Asia"
rownames(NetMatrix_continent)[rownames(NetMatrix_continent) == "China"] <- "Asia"
# Change India to Asia
colnames(NetMatrix_continent)[colnames(NetMatrix_continent) == "India"] <- "Asia"
rownames(NetMatrix_continent)[rownames(NetMatrix_continent) == "India"] <- "Asia"
# Change Phillipines to Asia
colnames(NetMatrix_continent)[colnames(NetMatrix_continent) == "Philippines"] <- "Asia"
rownames(NetMatrix_continent)[rownames(NetMatrix_continent) == "Philippines"] <- "Asia"
# Change "Brazil" to "South America"
colnames(NetMatrix_continent)[colnames(NetMatrix_continent) == "Brazil"] <- "South America"
rownames(NetMatrix_continent)[rownames(NetMatrix_continent) == "Brazil"] <- "South America"
# Change "Ecuador" to "South America"
colnames(NetMatrix_continent)[colnames(NetMatrix_continent) == "Ecuador"] <- "South America"
rownames(NetMatrix_continent)[rownames(NetMatrix_continent) == "Ecuador"] <- "South America"
# Change "Chile" to "South America"
colnames(NetMatrix_continent)[colnames(NetMatrix_continent) == "Chile"] <- "South America"
rownames(NetMatrix_continent)[rownames(NetMatrix_continent) == "Chile"] <- "South America"
# Change "United Kingdom" to "Europe" 
colnames(NetMatrix_continent)[colnames(NetMatrix_continent) =="UK"] <- "Europe"
rownames(NetMatrix_continent)[rownames(NetMatrix_continent) =="UK"] <- "Europe"
# Change "Romania" to "Europe"
colnames(NetMatrix_continent)[colnames(NetMatrix_continent) == "Romania"] <- "Europe"
rownames(NetMatrix_continent)[rownames(NetMatrix_continent) == "Romania"] <- "Europe"
# Change "Germany" to "Europe"
colnames(NetMatrix_continent)[colnames(NetMatrix_continent) == "Germany"] <- "Europe"
rownames(NetMatrix_continent)[rownames(NetMatrix_continent) == "Germany"] <- "Europe"
#Change "France" to "Europe"
colnames(NetMatrix_continent)[colnames(NetMatrix_continent) == "France"] <- "Europe"
rownames(NetMatrix_continent)[rownames(NetMatrix_continent) == "France"] <- "Europe"
#Change "Spain" to "Europe"
colnames(NetMatrix_continent)[colnames(NetMatrix_continent) == "Spain"] <- "Europe"
rownames(NetMatrix_continent)[rownames(NetMatrix_continent) == "Spain"] <- "Europe"
#Change "Portugal" to "Europe"
colnames(NetMatrix_continent)[colnames(NetMatrix_continent) == "Portugal"] <- "Europe"
rownames(NetMatrix_continent)[rownames(NetMatrix_continent) == "Portugal"] <- "Europe"
#Change "Sweden" to "Europe"
colnames(NetMatrix_continent)[colnames(NetMatrix_continent) == "Sweden"] <- "Europe"
rownames(NetMatrix_continent)[rownames(NetMatrix_continent) == "Sweden"] <- "Europe"
#Change "Italy" to "Europe"
colnames(NetMatrix_continent)[colnames(NetMatrix_continent) == "Italy"] <- "Europe"
rownames(NetMatrix_continent)[rownames(NetMatrix_continent) == "Italy"] <- "Europe"
#Change "Netherlands" to "Europe"
colnames(NetMatrix_continent)[colnames(NetMatrix_continent) == "Netherlands"] <- "Europe"
rownames(NetMatrix_continent)[rownames(NetMatrix_continent) == "Netherlands"] <- "Europe"
#Change "Norway" to "Europe"
colnames(NetMatrix_continent)[colnames(NetMatrix_continent) == "Norway"] <- "Europe"
rownames(NetMatrix_continent)[rownames(NetMatrix_continent) == "Norway"] <- "Europe"
#Change "Switzerland" to "Europe"
colnames(NetMatrix_continent)[colnames(NetMatrix_continent) == "Switzerland"] <- "Europe"
rownames(NetMatrix_continent)[rownames(NetMatrix_continent) == "Switzerland"] <- "Europe"
#Change "Czech Republic" to "Europe"
colnames(NetMatrix_continent)[colnames(NetMatrix_continent) == "Czech Republic"] <- "Europe"
rownames(NetMatrix_continent)[rownames(NetMatrix_continent) == "Czech Republic"] <- "Europe"

colnames(NetMatrix_continent)[colnames(NetMatrix_continent) == "Korea"] <- "Asia"
rownames(NetMatrix_continent)[rownames(NetMatrix_continent) == "Korea"] <- "Asia"

colnames(NetMatrix_continent)[colnames(NetMatrix_continent) == "Turkey"] <- "Europe"
rownames(NetMatrix_continent)[rownames(NetMatrix_continent) == "Turkey"] <- "Europe"


# collapsing
merge_matrix <- t(rowsum(t(NetMatrix_continent), group = colnames(NetMatrix_continent), na.rm = T))
merge_matrix2 <- rowsum(merge_matrix, group = rownames(merge_matrix))
# remove diagonal elements
diag(merge_matrix2) <- 0
# chord plot
chordDiagramFromMatrix(merge_matrix2)

# Create a chord diagram of the network matrix
fig6b <- chordDiagram(merge_matrix2, annotationTrack = "grid", preAllocateTracks = 1)
# Add a track to label each sector with its name
circos.trackPlotRegion(track.index = 1, panel.fun = function(x, y) {
  xlim = get.cell.meta.data("xlim")
  ylim = get.cell.meta.data("ylim")
  sector.name = get.cell.meta.data("sector.index")
  circos.text(mean(xlim), ylim[1] + 0.2, sector.name, facing = "clockwise", niceFacing = TRUE, adj = c(0, 1))
  circos.axis(h = "top", labels.cex = 0.5, major.tick.length = 0.2, sector.index = sector.name, track.index = 2)
}, bg.border = NA)


```
