---
title: "zf_sm_code"
authors: "Kyle Morrison, Manuela Santana, Yefeng Yang, Malgorazata Lagisz and, Shinichi Nakagawa"
output: html_document
date: "2023-03-01"
---

Mapping the Behavioral Impacts of Pesticide Exposure on Zebrafish: A Systematic Evidence Map and Bibliometric Analysis

In this Rmarkdown we provide the following workflow:

- Objective 1.	To investigate the types of pesticides and pesticide classes, both in terms of chemical and target, that have been used in experiments examining the effects of pesticide exposure on zebrafish behaviour.

- Objective 2.	To identify the specific behaviours that have been investigated in pesticide exposure experiments that use zebrafish as a model.

- Objective 3.	To identify similarities and differences in research patterns and terminology across different disciplines.

- Objective 4. To examine how are authors connected between countries and how is the literature connected between and within disciplines. 

```{r setup, results="hide"}
rm(list = ls())
knitr::opts_chunk$set(echo = TRUE)
pacman::p_load(tidyverse,
               here,
               stringr,
               knitr,
               formatR,
               forcats,
               ggplot2,
               hrbrthemes,
               patchwork,
               bibliometrix,
               igraph,
               tidyr,
               viridis,
               circlize,
               cowplot,
               mapproj)
```


All extracted data is stored in five separate **.csv** files representing different aspects of the data (extracted via structured predefined Google Forms - one per table). 

Bibliographic data records are exported from Scopus (including cited references field) in .bib format and locally saved as **scopus.bib**.    

```{r load data}
bib <- read_csv(here("data", "zf_sm_bibliometrics.csv"), skip = 0)
sd <- read_csv(here("data","zf_sm_study_details.csv"), skip = 0)
pd <- read_csv(here("data", "zf_sm_pesticide_details.csv"), skip = 0)
pdo <-read_csv(here("data","zf_sm_pesticide_dosage.csv"), skip = 0)
bd <- read_csv(here("data", "zf_sm_behaviour_details.csv"), skip = 0)
bib_sco <- convert2df(here("data","scopus.bib"), dbsource = "scopus", format = "bibtex")
# not to self to create a the bibliometric information 
```


```{r joining data}
# Left join study details to bibliometrics
bib_sd <- left_join(bib, sd, by = "study_id")

# Left join pesticide details to previous join
bib_sd_pd <- left_join(bib_sd, pd, by = "study_id")

# Left join pesticide dosage to previous join
bib_sd_pd_pdo <- left_join(bib_sd_pd, pdo, by = "study_id")

# Left join behaviour details to previous join
fd <- left_join(bib_sd_pd_pdo, bd, by = "study_id")

# view(fd)
```

```{r clean final data}
# removing timestamps and initals extaction

fd <- fd %>% 
           select(-starts_with("timestamp"), -starts_with("initials_extractor"))

# view(fd)
```


```{r fig 1 time trends}

fig1 <- fd %>% 
  count(publication_year) %>%
  ggplot(aes(x = publication_year, y = n)) +
  geom_col(width = 0.7, fill = "#4169E1") +
  geom_text(aes(label = n), vjust = -0.2, size = 4) +
  theme_minimal() +
  labs(x = "Year", y = "Article Count") +
  theme(legend.position = "none", 
    axis.title.x = element_text(size = 12, face = "bold"),
    axis.title.y = element_text(size = 12, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
    axis.text.y = element_text(size = 10),
    panel.grid.major.y = element_line(color = "gray"),
    panel.grid.minor.y = element_blank(),
    plot.title = element_text(size = 16, face = "bold")) +
  ggtitle("Number of Articles by Publication Year")

fig1
```


- Objective 1.	To investigate the types of pesticides and pesticide classes, both in terms of chemical and target, that have been used in experiments examining the effects of pesticide exposure on zebrafish behaviour.


```{r plot for total of individual pesticides used in pesticide exposure studies}
fig2a <- pd %>%
  separate_rows(pesticide_investigated, sep = ", ") %>%
  count(pesticide_investigated) %>%
  filter(n > 1) %>%
  ggplot(aes(x = n, y = reorder(pesticide_investigated, n))) +
  geom_bar(stat = "identity", fill = "#4169E1", color = "white", position = position_dodge(0.9)) +
  geom_text(aes(label = n), position = position_stack(vjust = 0.5), color = "white", size = 4) +
  labs(title = "Total Number of Pesticides Investigated",
    x = "Count",
    y = "Pesticide") +
    theme_minimal() +
    theme(panel.grid.major.y = element_blank(),
    axis.line.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.text.x = element_text(size = 9),
    axis.text.y = element_text(size = 9, hjust = 0),
    plot.title = element_blank()
    )

fig2a
```

```{r total for of each pesticide target class used in pesticide exposure studies}
fig2b <- pd %>%
  separate_rows(pesticide_target_class, sep = ", ") %>%  
  count(pesticide_target_class) %>%
  ggplot(aes(x = n, y = reorder(pesticide_target_class, n))) +
  geom_bar(stat = "identity", fill = "#4169E1", color = "white", position = position_dodge(0.9)) +
  geom_text(aes(label = n), position = position_stack(vjust = 0.5), color = "white", fontface = "bold", size = 3) +
  labs(title = "Total Number of Pesticides by Target Class",
       x = "Count",
       y = "Pesticide Target Class") +
  theme_minimal() +
  theme(
    panel.grid.major.y = element_blank(),
    axis.line.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.text.y = element_text(size = 9, hjust = 0),
    axis.title.x = element_text(size = 10),
    plot.title = element_blank()
  )

fig2b
```


```{r total for chemical class} 
fig2c <- pd %>%
  separate_rows(pesticide_chemical_class, sep = ", ") %>%  
  count(pesticide_chemical_class) %>%
  filter(n >1) %>% 
  ggplot(aes(x = n, y = reorder(pesticide_chemical_class, n))) +
  geom_bar(stat = "identity", fill = "#4169E1", color = "white", position = position_dodge(0.9)) +
  geom_text(aes(label = n), position = position_stack(vjust = 0.5), color = "white", fontface = "bold", size = 3) +
  labs(title = "Total Number of Pesticides by Chemical Class",
       x = "Count",
       y = "Pesticide Chemical Class") +
  theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
        axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_text(size = 9, hjust = 0),
    plot.title = element_blank()
  )
fig2c
```

```{r total route of exposure completed as a percentage}
total_route_count <- pdo %>% count(route)

# Calculate proportion and percentage for each category
route_pct <- pdo %>%
  count(route) %>%
  mutate(proportion = n/sum(total_route_count$n),
         percentage = proportion*100)

# Create bar plot with percentages
fig2d <- ggplot(route_pct, aes(x = reorder(route, percentage), y = percentage)) +
  geom_bar(stat = "identity", fill = "#4169E1", color = "white") +
  geom_text(aes(label = paste0(round(percentage, 1), "%")), hjust = -0.2) +
  labs(title = "Percentage of Pesticides by Route of Exposure",
       x = "Route of Exposure",
       y = "Percentage") +
   theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
        axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_text(size = 9, hjust = 0),
    plot.title = element_blank()) +
  coord_flip() + 
  ylim(0, 100)

fig2d
```



```{r}
fig2 <- ((fig2a | fig2b) /(fig2c | fig2d)  + plot_annotation(tag_levels = "A")) # note that we filter 2a and 2c for those greater than 1
fig2
```


```{r making dosages consistent for dosage comparisons}
pdo <- pdo %>%
  filter(!is.na(dosage_lowest)) %>% # remove rows with NA values
  mutate(dosage_lowest = as.numeric(dosage_lowest),
         dosage_lowest_unit = as.character(dosage_lowest_unit),
         dosage_unit_consistent = case_when(
           dosage_lowest_unit == "mg/L" ~ "ug/L",
           dosage_lowest_unit == "ng/L" ~ "ug/L",
           dosage_lowest_unit == "g/L" ~ "ug/L",
          dosage_lowest_unit == "ppb" ~ "ug/L",
            dosage_lowest_unit == "ppm" ~ "ug/L",
          dosage_lowest_unit == "ug/g" ~ "mg/kg",
           TRUE ~ dosage_lowest_unit
         ),
         dosage_lowest_convert_ugL = case_when(
           dosage_lowest_unit == "mg/L" ~ dosage_lowest * 1000,
           dosage_lowest_unit == "ng/L" ~ dosage_lowest / 1000,
           dosage_lowest_unit == "g/L" ~ dosage_lowest/1000000,
           dosage_lowest_unit == "ppm" ~ dosage_lowest/1000,
           TRUE ~ dosage_lowest
         ),dosage_highest = as.numeric(dosage_highest),
         dosage_highest_convert_ugL = case_when(
           dosage_highest_unit == "mg/L" ~ dosage_highest * 1000,
           dosage_highest_unit == "ng/L" ~ dosage_highest / 1000,
           dosage_highest_unit == "g/L" ~ dosage_highest/1000000,
           dosage_highest_unit == "ppm" ~ dosage_highest/1000,
           TRUE ~ dosage_highest
         ))
         

```

```{r comparison of lowest and highest dosages in waterbourne exposure methods}
pdo_waterbourne <- pdo %>%
  pivot_longer(cols = c(dosage_lowest, dosage_highest), 
               names_to = "dosage_type",
               values_to = "dosage_value") %>% 
  filter(route == "waterbourne", dosage_unit_consistent == "ug/L") %>%  # not we had to filter for those studies that gave concentration per litre
  mutate(dosage_type = if_else(dosage_type == "dosage_lowest", "Lowest Dosage Exposed", "Highest Dosage Exposed"))

fig2e <- ggplot(pdo_waterbourne, aes(x = dosage_type, y = log(dosage_value))) +
  geom_violin(fill = "#4169E1", alpha = 0.2, color = NA, trim = FALSE) +
  geom_boxplot(width = 0.05, fill = "white", color = "#4169E1", outlier.shape = NA) +
  geom_jitter(width = 0.1, height = 0.05, color = "#4169E1", alpha = 0.8) +
  labs(title = "Waterborne Exposures by Dosage in ug/L", x = "Waterborne exposure", y = "log(Dosage (ug/L))") +
  theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
        axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_text(size = 9, hjust = 0),
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust = 0.5))

fig2e

# there is not enough data to represent graphically for other exposure routes
```

```{r comparison of lowest and highest dosages of waterbourne exposure to deltamethrin}
pdo_waterbourne_deltamethrin <- pdo %>%
  pivot_longer(cols = c(dosage_lowest, dosage_highest), 
               names_to = "dosage_type",
               values_to = "dosage_value") %>% 
  filter(route == "waterbourne", dosage_unit_consistent == "ug/L", pesticide_investigated == "deltamethrin") %>%  # not we had to filter for those studies that gave concentration per litre
  mutate(dosage_type = if_else(dosage_type == "dosage_lowest", "Lowest Dosage Exposed", "Highest Dosage Exposed"))


fig2f <- ggplot(pdo_waterbourne_deltamethrin, aes(x = dosage_type, y = log(dosage_value))) +
   geom_violin(fill = "#4169E1", alpha = 0.2, color = NA, trim = FALSE) +
  geom_boxplot(width = 0.05, fill = "white", color = "#4169E1", outlier.shape = NA) +
  geom_jitter(width = 0.1, height = 0.05, color = "#4169E1", alpha = 0.5) +
  labs(title = "Waterborne Exposures of Deltamethrin by Dosage in ug/L", x = "Waterbourne exposure", y = "log(Dosage (ug/L))")  +
  theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
        axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_text(size = 9, hjust = 0))
fig2f
```


```{r comparison of lowest and highest dosages of waterbourne exposure to rotenone}
pdo_waterbourne_rotenone<- pdo %>%
  pivot_longer(cols = c(dosage_lowest, dosage_highest), 
               names_to = "dosage_type",
               values_to = "dosage_value") %>% 
  filter(route == "waterbourne", dosage_unit_consistent == "ug/L", pesticide_investigated == "rotenone") %>%  # not we had to filter for those studies that gave concentration per litre
  mutate(dosage_type = if_else(dosage_type == "dosage_lowest", "Lowest Dosage Exposed", "Highest Dosage Exposed"))

fig2g <- ggplot(pdo_waterbourne_rotenone, aes(x = dosage_type, y = log(dosage_value))) +
  geom_violin(fill = "#4169E1", alpha = 0.3, trim = FALSE, color = NA) +
  geom_boxplot(width = 0.05, fill = "white", color = "#4169E1", outlier.shape = NA) +
  geom_jitter(width = 0.1, height = 0.05, color = "#4169E1", alpha = 0.5) +
  labs(title = "Waterborne Exposures of Rotenone by Dosage in ug/L", x = "Waterbourne exposure", y = "log(Dosage (ug/L))")  +
  theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
        axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_text(size = 9, hjust = 0)) 

fig2g

```



```{r comparison of lowest and highest dosages of waterbourne exposure atrazine}
pdo_waterbourne_atrazine <- pdo %>%
  pivot_longer(cols = c(dosage_lowest, dosage_highest), 
               names_to = "dosage_type",
               values_to = "dosage_value") %>% 
  filter(route == "waterbourne", dosage_unit_consistent == "ug/L", pesticide_investigated == "atrazine") %>%  # not we had to filter for those studies that gave concentration per litre
  mutate(dosage_type = if_else(dosage_type == "dosage_lowest", "Lowest Dosage Exposed", "Highest Dosage Exposed"))

fig2h <- ggplot(pdo_waterbourne_atrazine, aes(x = dosage_type, y = log(dosage_value))) +
   geom_violin(fill = "#4169E1", alpha = 0.3, trim = FALSE, color = "NA") +
  geom_boxplot(width = 0.05, fill = "white", color = "#4169E1", outlier.shape = NA) +
  geom_jitter(width = 0.1, height = 0.05, color = "#4169E1", alpha = 0.5) +
  labs(title = "Waterborne Exposures of Atrazine by Dosage in ug/L", x = "Waterborne exposure", y = "log(Dosage (ug/L))")  +
  theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
        axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_text(size = 9, hjust = 0))  
fig2h

```

```{r comparison to lowest and highest dosages of waterbourne exposure to glyphosate}
pdo_waterbourne_glyphosate <- pdo %>%
  pivot_longer(cols = c(dosage_lowest, dosage_highest), 
               names_to = "dosage_type",
               values_to = "dosage_value") %>% 
  filter(route == "waterbourne", dosage_unit_consistent == "ug/L", pesticide_investigated == "glyphosate") %>%  # not we had to filter for those studies that gave concentration per litre
  mutate(dosage_type = if_else(dosage_type == "dosage_lowest", "Lowest Dosage Exposed", "Highest Dosage Exposed"))

fig2i <- ggplot(pdo_waterbourne_glyphosate, aes(x = dosage_type, y = log(dosage_value))) +
 geom_violin(fill = "#4169E1", alpha = 0.3, trim = FALSE, color = NA) +
  geom_boxplot(width = 0.05, fill = "white", color = "#4169E1", outlier.shape = NA) +
  geom_jitter(width = 0.1, height = 0.05, color = "#4169E1", alpha = 0.5) +
  labs(title = "Waterborne Exposures of Glyphosate by Dosage in ug/L", x = "Waterbourne exposure", y = "log(Dosage (ug/L))")  +
  theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
        axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_text(size = 9, hjust = 0),
        )  
fig2i

```

```{r comparison to lowest and highest dosages of waterbourne exposure to chlropyrifo}
pdo_waterbourne_chloropyrifo <- pdo %>%
  pivot_longer(cols = c(dosage_lowest, dosage_highest), 
               names_to = "dosage_type",
               values_to = "dosage_value") %>% 
  filter(route == "waterbourne", dosage_unit_consistent == "ug/L", pesticide_investigated == "chloropyrifo") %>%  # not we had to filter for those studies that gave concentration per litre
  mutate(dosage_type = if_else(dosage_type == "dosage_lowest", "Lowest Dosage Exposed", "Highest Dosage Exposed"))

fig2j <- ggplot(pdo_waterbourne_chloropyrifo, aes(x = dosage_type, y = log(dosage_value))) +
  geom_violin(fill = "#4169E1", alpha = 0.3, trim = FALSE, color = NA) +
  geom_boxplot(width = 0.05, fill = "white", color = "#4169E1", outlier.shape = NA) +
  geom_jitter(width = 0.1, height = 0.05, color = "#4169E1", alpha = 0.5) +
  labs(title = "Waterborne Exposures of Chloropyrifos by Dosage in ug/L", x = "Waterbourne exposure", y = "log(Dosage (ug/L))")  +
  theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
        axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_text(size = 9, hjust = 0)) 
fig2j
```

```{r total lifestage of exposure completed as a percentage}

# Calculate total count for each category
total_count <- sd %>% count(life_stage_exposure)

# Calculate proportion and percentage for each category
life_stage_pct <- sd %>%
    separate_rows(life_stage_exposure, sep = ", ") %>% 
  count(life_stage_exposure) %>%
  mutate(proportion = n/sum(total_count$n),
         percentage = proportion*100)

# Create bar plot with percentages
fig2k <- ggplot(life_stage_pct, aes(x = reorder(life_stage_exposure, percentage), y = percentage)) +
  geom_bar(stat = "identity", fill = "#4169E1", color = "white") +
  geom_text(aes(label = paste0(round(percentage, 1), "%")), hjust = -0.1) +
  labs(title = "Percentage of Pesticides by Life Stage of Exposure",
       x = "Life Stage of Exposure",
       y = "Percentage",
       fontsize = 14) +
  theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
        axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_text(size = 9, hjust = 0),
        axis.title = element_text(size = 12),
        plot.title = element_blank()) +
  coord_flip() + 
  ylim(0, 100)

fig2k
```


```{r}
# Calculate total count for each category
total_sex_count <- sd %>% count(sex)

# Calculate proportion and percentage for each category
sex_pct <- sd %>%
  count(sex) %>%
  mutate(proportion = n/sum(total_sex_count$n),
         percentage = proportion*100)

# Create bar plot with percentages
fig2l <- ggplot(sex_pct, aes(x = reorder(sex, percentage), y = percentage)) +
  geom_bar(stat = "identity", fill = "#4169E1", color = "white") +
  geom_text(aes(label = paste0(round(percentage, 1), "%")), hjust = -0.1) +
  labs(title = "Percentage of Pesticides by Sex of Exposure",
       x = "Sex of Exposure",
       y = "Percentage") +
   theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
        axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_text(size = 9, hjust = 0),
            plot.title = element_blank()) +
  coord_flip() + 
  ylim(0, 100)

fig2l
```


```{r}
fig3 <- ((fig2k) /(fig2l) + plot_annotation(tag_levels = "A"))
fig3
```

- Objective 2.	To identify the specific behaviours that have been investigated in pesticide exposure experiments that use zebrafish as a model.

```{r total number of studies investigating each broad behaviour class}
fig3a <- bd %>%
  separate_rows(behavioural_class, sep = ",\\s*") %>%  
  count(behavioural_class) %>%
  ggplot(aes(x = n, y = reorder(behavioural_class, n))) +
  geom_bar(stat = "identity", fill =  "#4169E1", color = "white", position = position_dodge(0.9)) +
  geom_text(aes(label = n), position = position_stack(vjust = 0.5), color = "white", fontface = "bold", size = 3) +
  labs(title = "Total Number of studies investigating each Behavioural Class",
       x = "Count",
       y = "Behavioural Class") +
   theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
        axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_text(size = 9, hjust = 0),
            plot.title = element_blank()
) 
fig3a
```

```{r total number of studies investigating each behavioural assay of behaviour activity}
fig3b <- bd %>%
  separate_rows(behaviour_activity, sep = ",\\s*") %>%  
  count(behaviour_activity) %>%
   na.omit() %>%
  ggplot(aes(x = reorder(behaviour_activity, n), y = n)) +
  geom_bar(stat = "identity", fill = "#4169E1", color = "white", position = position_dodge(0.9)) +
  geom_text(aes(label = n), position = position_stack(vjust = 0.5), color = "white", fontface = "bold", size = 3) +
  labs(title = "Behavioural assays investigating Activity",
       x = "Activity Assay",
       y = "Count") +
theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
        axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_text(size = 9, hjust = 0),
        plot.title = element_blank()) +
        coord_flip()

fig3b
```

Note to not use graph of aggression assay 
```{r total number of studies investigating each behavioural assay of behaviour_aggression }
fig3c <- bd %>%
  separate_rows(behaviour_aggression, sep = ",\\s*") %>%  
  count(behaviour_aggression) %>%
  na.omit() %>%
  ggplot(aes(x = reorder(behaviour_aggression, n), y = n)) +
  geom_bar(stat = "identity", fill = "#4169E1", color = "white", position = position_dodge(0.9)) +
  geom_text(aes(label = n), position = position_stack(vjust = 0.5), color = "white", fontface = "bold", size = 3) +
  labs(title = "Behavioural assays investigating Aggression",
       x = "Aggression Assay",
       y = "Count") +
theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
        axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_text(size = 9, hjust = 0),
        plot.title = element_blank()) +
        coord_flip()
 

fig3c

```

```{r total number of studies investigating each behavioural assay of behavioural_sociality}
fig3d <- bd %>%
  separate_rows(behaviour_sociality, sep = ",\\s*") %>%  
  count(behaviour_sociality) %>%
  na.omit() %>%
  ggplot(aes(x = reorder(behaviour_sociality, n), y = n)) +
  geom_bar(stat = "identity", fill = "#4169E1", color = "white", position = position_dodge(0.9)) +
  geom_text(aes(label = n), position = position_stack(vjust = 0.5), color = "white", fontface = "bold", size = 3) +
  labs(title = "Behavioural assays investigating Sociality",
       x = "Sociality Assay",
       y = "Count") +
  theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
        axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_text(size = 9, hjust = 0),
        plot.title = element_blank()) +
        coord_flip()
 

fig3d
```


```{r total number of studies investigating each behavioural assay of behavioural_foraging}
fig3e <- bd %>%
  separate_rows(behaviour_foraging, sep = ",\\s*") %>%  
  count(behaviour_foraging) %>%
  na.omit() %>%
  ggplot(aes(x = reorder(behaviour_foraging, n), y = n)) +
  geom_bar(stat = "identity", fill = "#4169E1", color = "white", position = position_dodge(0.9)) +
  geom_text(aes(label = n), position = position_stack(vjust = 0.5), color = "white", fontface = "bold", size = 3) +
  labs(title = "Behavioural assays investigating Foraging Behaviour",
       x = "Foraging Assay",
       y = "Count") +
  theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
        axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_text(size = 9, hjust = 0),
        plot.title = element_blank()) +
        coord_flip()
fig3e
```


```{r total number of studies investigating each behavioural assay of anti predator behaviour}
fig3f <- bd %>%
  separate_rows(behaviour_antipredator, sep = ",\\s*") %>%  
  count(behaviour_antipredator) %>%
  na.omit() %>%
  ggplot(aes(x = reorder(behaviour_antipredator, n), y = n)) +
  geom_bar(stat = "identity", fill = "#4169E1", color = "white", position = position_dodge(0.9)) +
  geom_text(aes(label = n), position = position_stack(vjust = 0.5), color = "white", fontface = "bold", size = 3) +
  labs(title = "Behavioural assays investigating Anti-Predator Behaviour",
       x = "Antipredator Assay",
       y = "Count") +
    theme_minimal() +
  theme(panel.grid.major.y = element_blank(),
        axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_text(size = 9, hjust = 0),
        plot.title = element_blank()) +
        coord_flip()

fig3f
```

```{r creating a panel for behavioural mapping charts}
fig3 <- ((fig3a | fig3b) /(fig3c | fig3d) / (fig3e | fig3f)  + plot_annotation(tag_levels = "A"))

fig3
```


```{r heat map to show which behavours have been investigated in which pesticide target class }
fd_bc <- separate_rows(fd, behavioural_class, sep = ",\\s*", convert = TRUE)
fd_bcpt <- separate_rows(fd_bc, pesticide_target_class, sep = ",", convert = TRUE)

fd_summary <- fd_bcpt %>%
  mutate(behavioural_class = str_trim(behavioural_class),
         pesticide_target_class = str_trim(pesticide_target_class)) %>%
  group_by(behavioural_class, pesticide_target_class) %>%
  summarise(count = n()) %>%
  ungroup() 

# Create a heatmap using ggplot2
fig4a <- ggplot(fd_summary, aes(x = pesticide_target_class, y = behavioural_class, fill = count)) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "#BFEFFF", high = "#0047AB") +
  geom_text(aes(label = count), color = "black", size = 4) +  # Add text labels
  labs(x = "Pesticide Target Class", y = "Behavioural Class", fill = "Count") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5, size = 12),
        axis.text.y = element_text(size = 12),
        axis.title = element_text(size = 16, color = "black", face = "bold"),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 14, color = "black", face = "bold"))


fig4a
```

```{r heat map to show which behavours have been investigated in which pesticide chemical class}
fd_bc <- separate_rows(fd, behavioural_class, sep = ",", convert = TRUE)
fd_bcpc <- separate_rows(fd_bc, pesticide_chemical_class, sep = ",", convert = TRUE)

# Get the top 5 most numerous pesticide chemical classes
fd_summary <- fd_bcpc %>%
  mutate(behavioural_class = str_trim(behavioural_class),
         pesticide_target_class = str_trim(pesticide_chemical_class)) %>%
  group_by(behavioural_class, pesticide_chemical_class) %>%
  summarise(count = n()) %>%
  ungroup() 

top_pesticide_classes <- fd_summary %>%
  filter(!is.na(pesticide_chemical_class)) %>%
  group_by(pesticide_chemical_class) %>%
  summarise(count = sum(count)) %>%
  ungroup() %>%
  top_n(5, count) %>%
  pull(pesticide_chemical_class)

# Subset the data to include only the top 5 classes
fd_summary_top5 <- fd_summary %>%
  filter(pesticide_chemical_class %in% top_pesticide_classes)

# Create a heatmap using ggplot2
fig4b <- ggplot(fd_summary_top5, aes(x = pesticide_chemical_class, y = behavioural_class, fill = count)) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "#BFEFFF", high = "#0047AB") +
  geom_text(aes(label = ifelse(count > 0, count, "")), color = "black", size = 4) +  # Add text labels
  labs(x = "Pesticide Chemical Class", y = "Behavioural Class", fill = "Count") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust=0.5, size = 12),
        axis.text.y = element_text(size = 12),
        axis.title = element_text(size = 16, color = "black", face = "bold"),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 14, color = "black", face = "bold"))
fig4b

```

```{r heat map to show which life stages of exposure have been exposed to each pesticide chemical class}
fd_lse <- separate_rows(fd, life_stage_exposure, sep = ",", convert = TRUE)
fd_lsepc <- separate_rows(fd_lse, pesticide_chemical_class, sep = ",", convert = TRUE)

fd_summary <- fd_lsepc %>%
  mutate(life_stage_exposure = str_trim(life_stage_exposure),
         pesticide_chemical_class = str_trim(pesticide_chemical_class)) %>%
  group_by(life_stage_exposure, pesticide_chemical_class) %>%
  summarise(count = n()) %>%
  ungroup()

top_pesticide_classes <- fd_summary %>%
  filter(!is.na(pesticide_chemical_class)) %>%
  group_by(pesticide_chemical_class) %>%
  summarise(count = sum(count)) %>%
  ungroup() %>%
  top_n(5, count) %>%
  pull(pesticide_chemical_class)

fd_summary_top5 <- fd_summary %>%
  filter(pesticide_chemical_class %in% top_pesticide_classes)

fig4c <- ggplot(fd_summary_top5, aes(x = pesticide_chemical_class, y = life_stage_exposure, fill = count)) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "#BFEFFF", high = "#0047AB") +
  geom_text(aes(label = ifelse(count > 0, count, "")), color = "black", size = 4) +
  labs(x = "Pesticide Chemical Class", y = "Life Stage Exposure", fill = "Count") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 12),
        axis.text.y = element_text(size = 12),
        axis.title = element_text(size = 16, color = "black", face = "bold"),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 14, color = "black", face = "bold"))

fig4c
```

```{r}
fd_lse <- separate_rows(fd, life_stage_exposure, sep = ",", convert = TRUE)
fd_lsetc <- separate_rows(fd_lse, pesticide_target_class, sep = ",", convert = TRUE)

fd_summary <- fd_lsetc %>%
  mutate(life_stage_exposure = str_trim(life_stage_exposure),
         pesticide_target_class = str_trim(pesticide_target_class)) %>%
  group_by(life_stage_exposure, pesticide_target_class) %>%
  summarise(count = n()) %>%
  ungroup()

top_pesticide_classes <- fd_summary %>%
  filter(!is.na(pesticide_target_class)) %>%
  group_by(pesticide_target_class) %>%
  summarise(count = sum(count)) %>%
  ungroup() %>%
  top_n(5, count) %>%
  pull(pesticide_target_class)

fd_summary_top5 <- fd_summary %>%
  filter(pesticide_target_class %in% top_pesticide_classes)

fig4d <- ggplot(fd_summary_top5, aes(x = pesticide_target_class, y = life_stage_exposure, fill = count)) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "#BFEFFF", high = "#0047AB") +
  geom_text(aes(label = ifelse(count > 0, count, "")), color = "black", size = 4) +
  labs(x = "Pesticide Target Class", y = "Life Stage Exposure", fill = "Count") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 12),
        axis.text.y = element_text(size = 12),
        axis.title = element_text(size = 16, color = "black", face = "bold"),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 14, color = "black", face = "bold"))
fig4d

```


```{r}
fig4 <- ((fig4a | fig4b) /(fig4c  | fig4d )   + plot_annotation(tag_levels = "A"))

fig4
```

- Objective 4. To examine how are authors connected between countries and how is the literature connected between and within disciplines.

```{r general bibliometric summaries}
fig4a <- biblioAnalysis(bib_sco)
plot(fig4a)
```

```{r co-occurance matrix}
NetMatrix_keywords <- biblioNetwork(bib_sco, analysis = "co-occurrences", network = "keywords", sep = ";")
fig4b <- networkPlot(NetMatrix_keywords, normalize="association", n = 10, 
                     Title = "Keyword Co-occurrences", type = "fruchterman", 
                     size.cex = TRUE, size = 10, remove.multiple = F, 
                     edgesize = 4, labelsize = 3, label.cex = TRUE, 
                     edges.min = 2, label.n = 9, alpha = 0.3) 
```


```{r thematic map based on keywords}
par(mfrow=c(1,1), mar=c(0,2,0,2))
fig4c <- thematicMap(bib_sco, field = "ID", n = 1000, minfreq = 5, stemming = FALSE, size = 0.5, n.labels = 1, repel = TRUE)
plot(fig4c$map)

```


```{r author collaboration network}
NetMatrix_authors <- biblioNetwork(bib_sco, analysis = "collaboration",  network = "authors", sep = ";")
fig4d <- networkPlot(NetMatrix_authors,  n = 50, 
                                      Title = "Author collaboration", 
                                      type = "auto", size = 2, size.cex = TRUE, 
                                      edgesize = 10, labelsize = 1.1)
```

```{r country publications map}

bibmap <- metaTagExtraction(bib_sco, Field = "AU1_CO", sep = ";") 
bibmap <- metaTagExtraction(bibmap, Field = "AU_CO", sep = ";") 
#save counts in a data frame
bibmap %>% group_by(AU1_CO) %>% count() %>% filter(!is.na(AU1_CO)) -> firstcountrycounts
#load map data
world_map <- map_data("world") %>% 
  filter(! long > 180) #remove countries with longitude >180 to make equal projection-like map without artifacts
#table(world_map$region) #note that United Kingdom is UK here
# Format country names to match regions on the world map
firstcountrycounts$region <- str_to_title(firstcountrycounts$AU1_CO)
firstcountrycounts$region[firstcountrycounts$region == "Usa"] <- "USA" #Fix "Usa" to "USA" :
firstcountrycounts$region[firstcountrycounts$region == "United Kingdom"] <- "UK" #fix to "UK"
#(firstcountrycounts$region) %in% world_map$region #check matching
## colour all regions on the map:
emptymap <- tibble(region = unique(world_map$region), n = rep(0,length(unique(world_map$region)))) #create table with all counts as 0
fullmap <- left_join(emptymap, firstcountrycounts, by = "region") #join with actual counts table
fullmap$n <- fullmap$n.x + fullmap$n.y # make new column for fixed counts
fullmap$n[is.na(fullmap$n)] <- 0 #change NA to 0 for regions with no counts
fig4e <- fullmap %>% 
  ggplot(aes(fill = n, map_id = region)) +
  geom_map(map = world_map) +
  expand_limits(x = world_map$long, y = world_map$lat) +
  coord_map("moll") +
  theme_map(line_size = 0.5) + 
  theme(legend.position="right") +
  scale_fill_gradient(low = "#7BCCC4", high = "#084081",
                    name = "Score", na.value = "gray50",
 limits = c(1, 12),
      guide = guide_colorbar(direction = "vertical.")) +
  guides(fill = guide_colourbar(barwidth = unit(15, units = "mm"), barheight = unit(20, units = "mm")))
fig4e
```

```{r country collaboration network circle plot}
# Extract countries from the affiliations
bib_sco2 <- metaTagExtraction(bib_sco, Field = "AU_CO", sep = ";")

# Create a network matrix of collaborations between countries
NetMatrix_country <- biblioNetwork(bib_sco2, analysis = "collaboration", network = "countries", sep = ";")

# Convert the network matrix to a standard matrix
NetMatrix_country <- as.matrix(NetMatrix_country)

# Remove the lower triangle (as this is duplication of info)
NetMatrix_country[lower.tri(NetMatrix_country)] <- 0 

# Change column and row names to title case
colnames(NetMatrix_country) <- str_to_title(colnames(NetMatrix_country))
rownames(NetMatrix_country) <- str_to_title(rownames(NetMatrix_country))

# Change "Usa" to "USA"
colnames(NetMatrix_country)[colnames(NetMatrix_country) == "Usa"] <- "USA"
rownames(NetMatrix_country)[rownames(NetMatrix_country) == "Usa"] <- "USA"

# Change "United Kingdom" to "UK" for easier plotting
colnames(NetMatrix_country)[colnames(NetMatrix_country) == "United Kingdom"] <- "UK"
rownames(NetMatrix_country)[rownames(NetMatrix_country) == "United Kingdom"] <- "UK"

# Change "Newzealand" to "New Zealand"
colnames(NetMatrix_country)[colnames(NetMatrix_country) == "Newzealand"] <- "New Zealand"
rownames(NetMatrix_country)[rownames(NetMatrix_country) == "Newzealand"] <- "New Zealand"

# Define colors for each country
my.cols2 <- c(
  USA = "#377eb8",
  Australia = "#e41a1c",
  Netherlands = "#4daf4a",
  UK = "#984ea3",
  Brazil = "#ff7f00",
  Canada = "#a65628",
  NewZealand = "#f781bf",
  France = "#999999",
  Germany = "#ffff33",
  Italy = "#a65628",
  Argentina = "#377eb8",
  China = "#e41a1c",
  Belgium = "#4daf4a",
  Sweden = "#984ea3",
  Mexico = "#f781bf",
  Poland = "#999999",
  Turkey = "#ff7f00",
  Portugal = "#ffff33"
)

# Create a chord diagram of the network matrix
fig4f <- chordDiagram(NetMatrix_country, annotationTrack = "grid", preAllocateTracks = 1, grid.col = my.cols2)

# Add a track to label each sector with its name
circos.trackPlotRegion(track.index = 1, panel.fun = function(x, y) {
  xlim = get.cell.meta.data("xlim")
  ylim = get.cell.meta.data("ylim")
  sector.name = get.cell.meta.data("sector.index")
  circos.text(mean(xlim), ylim[1] + .1, sector.name, facing = "clockwise", niceFacing = TRUE, adj = c(0, 0.5))
  circos.axis(h = "top", labels.cex = 0.5, major.tick.percentage = 0.2, sector.index = sector.name, track.index = 2)
}, bg.border = NA)

```


```{r most cited articles and authors}

CR <- citations(bib_sco, field = "article", sep = ";") #list of most cited articles
 cbind(CR$Cited[1:10]) #ten most cited articles
 
CR <- citations(bib_sco, field = "author", sep = ";")
cbind(CR$Cited[1:10]) #ten most cited authors
``` 

```{r bibliometric coupling network}
NetMatrix_coupling <- biblioNetwork(bib_sco, analysis = "coupling", network = "references", sep = "; ")
NetMatrix_coupling_plot <- networkPlot(NetMatrix_coupling, n = 20, 
                                       Title = "Paper co-citation", type = "fruchterman", size=T, 
                                       remove.multiple=FALSE, labelsize=0.8,edgesize = 5)
```

