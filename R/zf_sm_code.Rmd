---
title: "zf_sm_code"
authors: "Kyle Morrison, Yefeng Yang, Manuela Santana, Malgorazata Lagisz and, Shinichi Nakagawa"
output: html_document
date: "2023-03-01"
---

Mapping the Behavioral Impacts of Pesticide Exposure on Zebrafish: A Systematic Evidence Map and Bibliometric Analysis

In this Rmarkdown we provide the following workflow:

- Objective 1.	To investigate the types of pesticides and pesticide classes, both in terms of chemical and target, that have been used in experiments examining the effects of pesticide exposure on zebrafish behaviour.

- Objective 2.	To identify the specific behaviours that have been investigated in pesticide exposure experiments that use zebrafish as a model.

- Objective 3.	To identify similarities and differences in research patterns and terminology across different disciplines.

- Objective 4. To examine how are authors connected between countries and how is the literature connected between and within disciplines. 

```{r setup, , results="hide"}
rm(list = ls())
knitr::opts_chunk$set(echo = TRUE)
pacman::p_load(tidyverse,
               here,
               stringr,
               knitr,
               formatR,
               forcats,
               ggplot2,
               hrbrthemes,
               patchwork,
               bibliometrix,
               igraph,
               tidyr,
               viridis)
```


All extracted data is stored in five separate **.csv** files representing different aspects of the data (extracted via structured predefined Google Forms - one per table). 

Bibliographic data records are exported from Scopus (including cited references field) in .bib format and locally saved as **scopus.bib**.    

```{r load data}
bib <- read_csv(here("data", "zf_sm_bibliometrics.csv"), skip = 0)
sd <- read_csv(here("data","zf_sm_study_details.csv"), skip = 0)
pd <- read_csv(here("data", "zf_sm_pesticide_details.csv"), skip = 0)
pdo <-read_csv(here("data","zf_sm_pesticide_dosage.csv"), skip = 0)
bd <- read_csv(here("data", "zf_sm_behaviour_details.csv"), skip = 0)

# not to self to create a the bibliometric information 
```


```{r joining data}
# Left join study details to bibliometrics
bib_sd <- left_join(bib, sd, by = "study_id")

# Left join pesticide details to previous join
bib_sd_pd <- left_join(bib_sd, pd, by = "study_id")

# Left join pesticide dosage to previous join
bib_sd_pd_pdo <- left_join(bib_sd_pd, pdo, by = "study_id")

# Left join behaviour details to previous join
fd <- left_join(bib_sd_pd_pdo, bd, by = "study_id")

# view(fd)
```

```{r clean final data}
# removing timestamps and initals extaction

fd <- fd %>% 
           select(-starts_with("timestamp"), -starts_with("initials_extractor"))

# view(fd)
```


```{r fig 1 time trends}

fig1 <- fd %>% 
  count(publication_year) %>%
  ggplot(aes(x = publication_year, y = n)) +
  geom_col(width = 0.7, fill = "black") +
  geom_text(aes(label = n), vjust = -0.2, size = 3.5) +
  theme_classic() +
  labs(x = "Year", y = "Article count") +
  theme(legend.position = "none", 
        axis.title.x = element_text(size = 10),
        axis.text.x = element_text(angle = 45, hjust = 1))
# fig1
```


- Objective 1.	To investigate the types of pesticides and pesticide classes, both in terms of chemical and target, that have been used in experiments examining the effects of pesticide exposure on zebrafish behaviour.


```{r plot for total of individual pesticide}

fig2 <- pd %>%
  separate_rows(pesticide_investigated, sep = ", ") %>% 
  count(pesticide_investigated) %>%
  ggplot(aes(x = n, y = reorder(pesticide_investigated, n))) +
  geom_bar(stat = "identity", fill = "black", color = "white", position = position_dodge(0.9)) +
  geom_text(aes(label = n), position = position_stack(vjust = 0.5), color = "white", fontface = "bold", size = 2) + 
  labs(title = "Total Number of Pesticides Investigated",
       x = "Count",
       y = "Pesticide") +
  theme_classic()

fig2
```

```{r total for target class}
fig3 <- pd %>%
  separate_rows(pesticide_target_class, sep = ", ") %>%  
  count(pesticide_target_class) %>%
  ggplot(aes(x = n, y = reorder(pesticide_target_class, n))) +
  geom_bar(stat = "identity", fill = "black", color = "white", position = position_dodge(0.9)) +
  geom_text(aes(label = n), position = position_stack(vjust = 0.5), color = "white", fontface = "bold", size = 3) +
  labs(title = "Total Number of Pesticides by Target Class",
       x = "Count",
       y = "Pesticide Target Class") +
  theme_classic()

fig3
```


```{r total for chemical class}
fig4 <- pd %>%
  separate_rows(pesticide_chemical_class, sep = ", ") %>%  
  count(pesticide_chemical_class) %>%
  ggplot(aes(x = n, y = reorder(pesticide_chemical_class, n))) +
  geom_bar(stat = "identity", fill = "black", color = "white", position = position_dodge(0.9)) +
  geom_text(aes(label = n), position = position_stack(vjust = 0.5), color = "white", fontface = "bold", size = 3) +
  labs(title = "Total Number of Pesticides by Chemical Class",
       x = "Count",
       y = "Pesticide Chemical Class") +
  theme_classic()

fig4
```

```{r total route of exposure completed as a percentage}
# Calculate total count for each category
total_count <- pdo %>% count(route)

# Calculate proportion and percentage for each category
route_pct <- pdo %>%
  count(route) %>%
  mutate(proportion = n/sum(total_count$n),
         percentage = proportion*100)

# Create bar plot with percentages
fig5 <- ggplot(route_pct, aes(x = reorder(route, percentage), y = percentage)) +
  geom_bar(stat = "identity", fill = "black", color = "white") +
  geom_text(aes(label = paste0(round(percentage, 1), "%")), hjust = -0.1) +
  labs(title = "Percentage of Pesticides by Route of Exposure",
       x = "Route of Exposure",
       y = "Percentage") +
  theme_classic() +
  coord_flip()

fig5
```



```{r making dosages consistent for dosage comparisons}
pdo <- pdo %>%
  filter(!is.na(dosage_lowest)) %>% # remove rows with NA values
  mutate(dosage_lowest = as.numeric(dosage_lowest),
         dosage_lowest_unit = as.character(dosage_lowest_unit),
         dosage_unit_consistent = case_when(
           dosage_lowest_unit == "mg/L" ~ "ug/L",
           dosage_lowest_unit == "ng/L" ~ "ug/L",
           dosage_lowest_unit == "g/L" ~ "ug/L",
          dosage_lowest_unit == "ppb" ~ "ug/L",
            dosage_lowest_unit == "ppm" ~ "ug/L",
          dosage_lowest_unit == "ug/g" ~ "mg/kg",
           TRUE ~ dosage_lowest_unit
         ),
         dosage_lowest_convert_ugL = case_when(
           dosage_lowest_unit == "mg/L" ~ dosage_lowest * 1000,
           dosage_lowest_unit == "ng/L" ~ dosage_lowest / 1000,
           dosage_lowest_unit == "g/L" ~ dosage_lowest/1000000,
           dosage_lowest_unit == "ppm" ~ dosage_lowest/1000,
           TRUE ~ dosage_lowest
         ),dosage_highest = as.numeric(dosage_highest),
         dosage_highest_convert_ugL = case_when(
           dosage_highest_unit == "mg/L" ~ dosage_highest * 1000,
           dosage_highest_unit == "ng/L" ~ dosage_highest / 1000,
           dosage_highest_unit == "g/L" ~ dosage_highest/1000000,
           dosage_highest_unit == "ppm" ~ dosage_highest/1000,
           TRUE ~ dosage_highest
         ))
         

```

```{r comparison of lowest and highest dosages in waterbourne exposure methods}
pdo_waterbourne <- pdo %>%
  pivot_longer(cols = c(dosage_lowest, dosage_highest), 
               names_to = "dosage_type",
               values_to = "dosage_value") %>% 
  filter(route == "waterbourne", dosage_unit_ugl == "ug/L") %>%  # not we had to filter for those studies that gave concentration per litre
  mutate(dosage_type = if_else(dosage_type == "dosage_lowest", "Lowest Dosage Exposed", "Highest Dosage Exposed"))


fig6 <- ggplot(pdo_waterbourne, aes(x = dosage_type, y = log(dosage_value))) +
  geom_violin(fill = "gray", alpha = 0.5) +
  geom_boxplot(width = 0.1, fill = "white", color = "black") +
  geom_jitter(width = 0.1, height = 0.05) +
  labs(title = "Waterborne Exposures by Dosage in ug/L", x = "Waterbourne exposure", y = "log(Dosage (ug/L))") +
  theme_classic() 

fig6

# there is not enough data to represent graphically for other exposure routes
```

```{r comparison of lowest and highest dosages of waterbourne exposure to deltamethrin}
pdo_waterbourne_deltamethrin <- pdo %>%
  pivot_longer(cols = c(dosage_lowest, dosage_highest), 
               names_to = "dosage_type",
               values_to = "dosage_value") %>% 
  filter(route == "waterbourne", dosage_unit_ugl == "ug/L", pesticide_investigated == "deltamethrin") %>%  # not we had to filter for those studies that gave concentration per litre
  mutate(dosage_type = if_else(dosage_type == "dosage_lowest", "Lowest Dosage Exposed", "Highest Dosage Exposed"))


fig7 <- ggplot(pdo_waterbourne_deltamethrin, aes(x = dosage_type, y = log(dosage_value))) +
  geom_violin(fill = "gray", alpha = 0.5) +
  geom_boxplot(width = 0.1, fill = "white", color = "black") +
  geom_jitter(width = 0.1, height = 0.05) +
  labs(title = "Waterborne Exposures by Dosage in ug/L", x = "Waterbourne exposure", y = "log(Dosage (ug/L))") +
  theme_classic() 
fig7
```


```{r comparison of lowest and highest dosages of waterbourne exposure to rotenone}
pdo_waterbourne_deltamethrin <- pdo %>%
  pivot_longer(cols = c(dosage_lowest, dosage_highest), 
               names_to = "dosage_type",
               values_to = "dosage_value") %>% 
  filter(route == "waterbourne", dosage_unit_ugl == "ug/L", pesticide_investigated == "deltamethrin") %>%  # not we had to filter for those studies that gave concentration per litre
  mutate(dosage_type = if_else(dosage_type == "dosage_lowest", "Lowest Dosage Exposed", "Highest Dosage Exposed"))


fig7 <- ggplot(pdo_waterbourne_deltamethrin, aes(x = dosage_type, y = log(dosage_value))) +
  geom_violin(fill = "gray", alpha = 0.5) +
  geom_boxplot(width = 0.1, fill = "white", color = "black") +
  geom_jitter(width = 0.1, height = 0.05) +
  labs(title = "Waterborne Exposures by Dosage in ug/L", x = "Waterbourne exposure", y = "log(Dosage (ug/L))") +
  theme_classic() 
fig7
```


- Objective 2.	To identify the specific behaviours that have been investigated in pesticide exposure experiments that use zebrafish as a model.

```{r total number of studies investigating each broad behaviour class}
fig7 <- bd %>%
  separate_rows(behavioural_class, sep = ",\\s*") %>%  
  count(behavioural_class) %>%
  ggplot(aes(x = n, y = reorder(behavioural_class, n))) +
  geom_bar(stat = "identity", fill = "black", color = "white", position = position_dodge(0.9)) +
  geom_text(aes(label = n), position = position_stack(vjust = 0.5), color = "white", fontface = "bold", size = 3) +
  labs(title = "Total Number of studies investigating each Behavioural Class",
       x = "Count",
       y = "Behavioural Class") +
  theme_classic()
fig7
```

```{r total number of studies investigating each behavioural assay of behaviour activity}
fig6 <- bd %>%
  separate_rows(behaviour_activity, sep = ",\\s*") %>%  
  count(behaviour_activity) %>%
   na.omit() %>%
  ggplot(aes(x = reorder(behaviour_activity, n), y = n)) +
  geom_bar(stat = "identity", fill = "black", color = "white", position = position_dodge(0.9)) +
  geom_text(aes(label = n), position = position_stack(vjust = 0.5), color = "white", fontface = "bold", size = 3) +
  labs(title = "Behavioural assays investigating Activity",
       x = "Activity Assay",
       y = "Count") +
  theme_classic() +
  coord_flip()

fig6
```

Note to not use graph of aggression assay 
```{r total number of studies investigating each behavioural assay of behaviour_aggression }
fig7 <- bd %>%
  separate_rows(behaviour_aggression, sep = ",\\s*") %>%  
  count(behaviour_aggression) %>%
  na.omit() %>%
  ggplot(aes(x = reorder(behaviour_aggression, n), y = n)) +
  geom_bar(stat = "identity", fill = "black", color = "white", position = position_dodge(0.9)) +
  geom_text(aes(label = n), position = position_stack(vjust = 0.5), color = "white", fontface = "bold", size = 3) +
  labs(title = "Behavioural assays investigating Aggression",
       x = "Aggression Assay",
       y = "Count") +
  theme_classic() +
  coord_flip()

fig7

```

```{r total number of studies investigating each behavioural assay of behavioural_sociality}
fig8 <- bd %>%
  separate_rows(behaviour_sociality, sep = ",\\s*") %>%  
  count(behaviour_sociality) %>%
  na.omit() %>%
  ggplot(aes(x = reorder(behaviour_sociality, n), y = n)) +
  geom_bar(stat = "identity", fill = "black", color = "white", position = position_dodge(0.9)) +
  geom_text(aes(label = n), position = position_stack(vjust = 0.5), color = "white", fontface = "bold", size = 3) +
  labs(title = "Behavioural assays investigating Sociality",
       x = "Sociality Assay",
       y = "Count") +
  theme_classic() +
  coord_flip()

fig8
```


```{r total number of studies investigating each behavioural assay of behavioural_foraging}
fig9 <- bd %>%
  separate_rows(behaviour_foraging, sep = ",\\s*") %>%  
  count(behaviour_foraging) %>%
  na.omit() %>%
  ggplot(aes(x = reorder(behaviour_foraging, n), y = n)) +
  geom_bar(stat = "identity", fill = "black", color = "white", position = position_dodge(0.9)) +
  geom_text(aes(label = n), position = position_stack(vjust = 0.5), color = "white", fontface = "bold", size = 3) +
  labs(title = "Behavioural assays investigating Foraging Behaviour",
       x = "Foraging Assay",
       y = "Count") +
  theme_classic() +
  coord_flip()

fig9
```


```{r}
fig10 <- bd %>%
  separate_rows(behaviour_antipredator, sep = ",\\s*") %>%  
  count(behaviour_antipredator) %>%
  na.omit() %>%
  ggplot(aes(x = reorder(behaviour_antipredator, n), y = n)) +
  geom_bar(stat = "identity", fill = "black", color = "white", position = position_dodge(0.9)) +
  geom_text(aes(label = n), position = position_stack(vjust = 0.5), color = "white", fontface = "bold", size = 3) +
  labs(title = "Behavioural assays investigating Anti-Predator Behaviour",
       x = "Antipredator Assay",
       y = "Count") +
  theme_classic() +
  coord_flip()

fig10
```



